<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B Sakan - إدارة مصروفات العمارات</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="B Sakan">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="B Sakan">
    <meta name="description" content="برنامج متكامل لإدارة العمارات والمصروفات">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3b82f6">

    <!-- Icons -->
    <link rel="icon" type="image/png" href="assets/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .receipt-print {
                border: 2px solid #000 !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            @page {
                margin: 0;
                size: auto;
            }
        }
        
        .receipt-border {
            border: 2px solid #000;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 120px;
        }
        
        .auth-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table tr:hover {
            background-color: #f9fafb;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 2px;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-1px);
        }

        .status-late {
            background-color: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-paid {
            background-color: #f0fdf4;
            color: #16a34a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .filter-section {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash mr-2"></i> أنت غير متصل بالإنترنت
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-bg flex items-center justify-center p-4 min-h-screen">
        <div class="auth-card w-full max-w-md p-8 fade-in">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl ml-3">
                        B
                    </div>
                    <span class="text-3xl font-bold text-gray-800">Sakan</span>
                </div>
                <p class="text-gray-600">برنامج متكامل لإدارة العمارات والمصروفات</p>
                <p class="text-sm text-gray-500 mt-2">شركة B Ventures LLC</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">تسجيل الدخول</h2>
                
                <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        البريد الإلكتروني
                    </label>
                    <input
                        type="email"
                        name="email"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل بريدك الإلكتروني"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل كلمة المرور"
                        required
                    />
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center space-x-2 space-x-reverse">
                        <input type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                        <span class="text-sm text-gray-600">تذكرني</span>
                    </label>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-800">نسيت كلمة المرور؟</a>
                </div>
                
                <button
                    type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold flex items-center justify-center"
                    id="login-btn"
                >
                    <span id="login-text">تسجيل الدخول</span>
                    <div id="login-spinner" class="loading-spinner hidden mr-2"></div>
                </button>
                
                <div class="text-center">
                    <p class="text-gray-600">
                        ليس لديك حساب؟ 
                        <button type="button" id="show-signup" class="text-blue-600 hover:text-blue-800 font-semibold">
                            سجل الآن
                        </button>
                    </p>
                </div>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">إنشاء حساب جديد</h2>
                
                <div id="signup-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                <div id="signup-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            الاسم الأول
                        </label>
                        <input
                            type="text"
                            name="firstName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="الاسم الأول"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            اسم العائلة
                        </label>
                        <input
                            type="text"
                            name="lastName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="اسم العائلة"
                            required
                        />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        البريد الإلكتروني
                    </label>
                    <input
                        type="email"
                        name="email"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل بريدك الإلكتروني"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="اختر كلمة مرور قوية"
                        required
                        minlength="6"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        تأكيد كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="confirmPassword"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="أعد إدخال كلمة المرور"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        رقم الهاتف
                    </label>
                    <input
                        type="tel"
                        name="phone"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="رقم الهاتف"
                    />
                </div>
                
                <div class="flex items-center">
                    <input
                        type="checkbox"
                        name="agreeTerms"
                        class="h-4 w-4 text-blue-600 rounded ml-2"
                        required
                    />
                    <label class="text-sm text-gray-600">
                        أوافق على 
                        <a href="#" class="text-blue-600 hover:text-blue-800">الشروط والأحكام</a>
                        و
                        <a href="#" class="text-blue-600 hover:text-blue-800">سياسة الخصوصية</a>
                    </label>
                </div>
                
                <button
                    type="submit"
                    class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center justify-center"
                    id="signup-btn"
                >
                    <span id="signup-text">إنشاء حساب</span>
                    <div id="signup-spinner" class="loading-spinner hidden mr-2"></div>
                </button>
                
                <div class="text-center">
                    <p class="text-gray-600">
                        لديك حساب بالفعل؟ 
                        <button type="button" id="show-login" class="text-blue-600 hover:text-blue-800 font-semibold">
                            سجل الدخول
                        </button>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application (Hidden until authenticated) -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="text-center md:text-right">
                        <h1 class="text-2xl font-bold text-gray-800">برنامج B Sakan لإدارة مصروفات العمارات</h1>
                        <div class="flex items-center justify-center md:justify-start space-x-2 space-x-reverse mt-1">
                            <select id="building-select" class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر العمارة...</option>
                            </select>
                            <p class="text-gray-600 text-sm" id="current-building">عمارة السالم 12</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="flex space-x-3 space-x-reverse flex-wrap justify-center gap-2">
                            <button id="add-building-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-building mr-1"></i> إضافة عمارة
                            </button>
                            <button id="add-owner-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-user-plus mr-1"></i> إضافة مالك
                            </button>
                            <button id="add-payment-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-money-bill-wave mr-1"></i> إضافة دفعة
                            </button>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 space-x-reverse bg-gray-100 rounded-lg px-3 py-2 hover:bg-gray-200 transition-colors">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm" id="user-avatar">
                                    U
                                </div>
                                <span class="text-sm font-medium text-gray-700" id="user-name">المستخدم</span>
                                <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                            </button>
                            <div id="user-menu" class="dropdown-menu hidden mt-2 right-0">
                                <div class="px-4 py-2 border-b border-gray-200">
                                    <p class="text-sm font-medium text-gray-800" id="menu-user-name">المستخدم</p>
                                    <p class="text-xs text-gray-500" id="menu-user-email">user@example.com</p>
                                </div>
                                <button class="w-full text-right px-4 py-2 hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-cog mr-2"></i> الإعدادات
                                </button>
                                <button id="logout-btn" class="w-full text-right px-4 py-2 hover:bg-gray-100 text-red-600">
                                    <i class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-container">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <!-- Tabs Section -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="flex space-x-2 space-x-reverse w-full md:w-auto">
                        <button id="tab-payments" class="tab-active px-4 py-2 rounded-lg transition-colors">
                            المعاملات
                        </button>
                        <button id="tab-owners" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            المالكين (<span id="owners-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Payments Tab Content -->
            <div id="payments-tab" class="tab-content">
                <!-- Transactions Filters -->
                <div class="filter-section">
                    <h3 class="text-lg font-semibold mb-4">تصفية المعاملات</h3>
                    <div class="filter-grid">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الشهر</label>
                            <select id="month-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">جميع الأشهر</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">المالك</label>
                            <select id="owner-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">جميع المالكين</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">نوع المعاملة</label>
                            <select id="type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">جميع الأنواع</option>
                                <option value="income">واردات</option>
                                <option value="expense">مصروفات</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">التصنيف</label>
                            <select id="category-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">جميع التصنيفات</option>
                                <option value="rent">إيجار</option>
                                <option value="maintenance">صيانة</option>
                                <option value="utilities">مرافق</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">من تاريخ</label>
                            <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">إلى تاريخ</label>
                            <input type="date" id="date-to" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <button id="apply-filters" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                تطبيق التصفية
                            </button>
                        </div>
                        <div>
                            <button id="reset-filters" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                                إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="table-container">
                        <table class="table" id="transactions-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>نوع المعاملة</th>
                                    <th>المالك</th>
                                    <th>الوصف</th>
                                    <th>المبلغ (د.أ)</th>
                                    <th>التصنيف</th>
                                    <th>الملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-container">
                                <!-- Transactions will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Owners Tab Content -->
            <div id="owners-tab" class="tab-content hidden">
                <!-- Owners Table -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="table-container">
                        <table class="table" id="owners-table">
                            <thead>
                                <tr>
                                    <th>اسم المالك</th>
                                    <th>رقم الشقة</th>
                                    <th>رقم الهاتف</th>
                                    <th>الاشتراك الشهري</th>
                                    <th>المبلغ المطلوب</th>
                                    <th>المبلغ المدفوع</th>
                                    <th>الأشهر المتأخرة</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="owners-container">
                                <!-- Owners will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-8">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">عن البرنامج</h3>
                        <p class="text-gray-300">برنامج B Sakan لإدارة العمارات والمصروفات</p>
                        <p class="text-gray-300 mt-2">شركة B Ventures LLC</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">روابط سريعة</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><a href="#" class="hover:text-white transition-colors">الدعم الفني</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الشروط والأحكام</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الأسئلة الشائعة</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">اتصل بنا</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><i class="fas fa-envelope mr-2"></i> info@bsakan.com</li>
                            <li><i class="fas fa-phone mr-2"></i> +218-91-123-4567</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">تابعنا</h3>
                        <div class="flex space-x-4 space-x-reverse">
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-4 text-center text-gray-400">
                    <p>© 2025 برنامج B Sakan. جميع الحقوق محفوظة. شركة B Ventures LLC</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Building Modal -->
    <div id="add-building-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة عمارة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل العمارة الجديدة</p>
                
                <form id="add-building-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم العمارة *
                        </label>
                        <input
                            type="text"
                            name="buildingName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل اسم العمارة"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            العنوان
                        </label>
                        <input
                            type="text"
                            name="buildingAddress"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل عنوان العمارة"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            عدد الوحدات
                        </label>
                        <input
                            type="number"
                            name="unitsCount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="عدد الوحدات السكنية"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            إضافة العمارة
                        </button>
                        <button
                            type="button"
                            id="cancel-building-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="add-owner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة مالك جديد</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل مالك الشقة الجديد</p>
                
                <form id="add-owner-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم المالك *
                        </label>
                        <input
                            type="text"
                            name="name"
                            class="w-full px-3 py-2 border border-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="أدخل اسم المالك"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            رقم الهاتف
                        </label>
                        <input
                            type="tel"
                            name="phone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="0791234567"
                        />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                رقم الشقة
                            </label>
                            <input
                                type="text"
                                name="apartmentNumber"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="1"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                الطابق
                            </label>
                            <input
                                type="text"
                                name="floor"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="الأول"
                            />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اتجاه الشقة
                        </label>
                        <select
                            name="direction"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">اختر اتجاه الشقة</option>
                            <option value="north">شمال</option>
                            <option value="south">جنوب</option>
                            <option value="east">شرق</option>
                            <option value="west">غرب</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            الاشتراك الشهري (د.أ)
                        </label>
                        <input
                            type="number"
                            name="subscription"
                            value="100.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة المالك
                        </button>
                        <button
                            type="button"
                            id="cancel-owner-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة دفعة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل الدفعة الجديدة سواء كانت واردات أو مصروفات</p>
                
                <form id="add-payment-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            نوع الدفعة
                        </label>
                        <select
                            name="type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="income">واردات</option>
                            <option value="expense">مصروفات</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            المبلغ (د.أ)
                        </label>
                        <input
                            type="number"
                            name="amount"
                            value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            وصف الدفعة
                        </label>
                        <input
                            type="text"
                            name="description"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="مثالاً: اشتراك شقة رقم 1 أو أجرة سباك"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            مالك الشقة *
                        </label>
                        <select
                            name="owner"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                            id="payment-owner-select"
                        >
                            <option value="">اختر مالك الشقة</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            تاريخ الدفعة
                        </label>
                        <input
                            type="date"
                            name="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            id="payment-date"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            تصنيف الدفعة
                        </label>
                        <select
                            name="category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="rent">إيجار</option>
                            <option value="maintenance">صيانة</option>
                            <option value="utilities">مرافق</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <input
                            type="checkbox"
                            name="advancePayment"
                            class="h-4 w-4 text-blue-600 rounded"
                            id="advance-payment-checkbox"
                        />
                        <label for="advance-payment-checkbox" class="text-sm font-medium text-gray-700">
                            دفعة مقدمة لعدة شهور
                        </label>
                    </div>
                    
                    <div id="months-selection" class="bg-gray-50 p-4 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">اختر الشهور المدفوعة</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2" id="months-grid">
                            <!-- Months will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة الدفعة
                        </button>
                        <button
                            type="button"
                            id="cancel-payment-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md receipt-border receipt-print" style="max-width: 500px;">
            <div class="p-6">
                <!-- Header -->
                <div class="text-center mb-6">
                    <div class="flex items-center justify-center mb-2">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg ml-2">
                            B
                        </div>
                        <span class="text-xl font-bold">Sakan</span>
                    </div>
                    <p class="text-gray-600 text-sm">شركة B Ventures LLC</p>
                    <h1 class="text-lg font-bold mt-2">برنامج B Sakan لإدارة وإصلاح ومصروفات العمارات</h1>
                    <p class="text-red-500 font-semibold" id="receipt-building-name">عمارة السالم 12</p>
                </div>
                
                <!-- Receipt Details -->
                <div class="border-t border-b border-gray-300 py-4 mb-4">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">سند قبض</h2>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">رقم السند:</span>
                            <span id="receipt-number">50</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">التاريخ:</span>
                            <span id="receipt-date">10-16-2025 م (1447-04-24 هـ)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">وصف الدفعة:</span>
                            <span id="receipt-description">تأمين للعمارة</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">اسم المستفيد:</span>
                            <span id="receipt-resident">محمد أحمد</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">رقم الشقة:</span>
                            <span id="receipt-unit">1</span>
                        </div>
                        <div class="flex justify-between" id="receipt-months-container">
                            <!-- Months will be added here if advance payment -->
                        </div>
                    </div>
                </div>
                
                <!-- Amount Section -->
                <div class="border-2 border-green-500 rounded-lg p-4 mb-6 text-center">
                    <p class="text-gray-600 mb-2">المبلغ المستلم</p>
                    <p class="text-green-600 text-3xl font-bold" id="receipt-amount">50 دينار أردني</p>
                </div>
                
                <!-- Footer -->
                <div class="text-center text-gray-600 text-sm">
                    <p class="font-medium mb-2">ملاحظات:</p>
                    <p class="mb-4" id="receipt-notes">قسط التامين السنوي</p>
                    <div class="flex items-center justify-center">
                        <span>www.bsakan.com</span>
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                    </div>
                </div>
                
                <div class="mt-6 text-center flex space-x-3 space-x-reverse justify-center no-print">
                    <button id="print-receipt-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-print mr-1"></i> طباعة
                    </button>
                    <button id="share-receipt-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fab fa-whatsapp mr-1"></i> مشاركة عبر واتساب
                    </button>
                    <button id="close-receipt-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7BqQkyqkdp1fTyrBKPeq0PQaPFE-SZag",
            authDomain: "bsakan-app.firebaseapp.com",
            projectId: "bsakan-app",
            storageBucket: "bsakan-app.firebasestorage.app",
            messagingSenderId: "654425697835",
            appId: "1:654425697835:web:9e8d9fd7b0571ba61cc46e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
          .catch((err) => {
              console.log('Firebase persistence failed: ', err);
          });

        // Firebase Authentication System
        class FirebaseAuthManager {
            constructor() {
                this.currentUser = null;
                this.authStateListeners = [];
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        this.currentUser = user;
                        this.showMainApp();
                    } else {
                        this.currentUser = null;
                        this.showAuthScreen();
                    }
                    
                    // Notify all listeners
                    this.authStateListeners.forEach(listener => listener(user));
                });
            }

            async login(email, password) {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    return { success: true, user: userCredential.user };
                } catch (error) {
                    let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage = 'البريد الإلكتروني غير صحيح';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'هذا الحساب معطل';
                            break;
                        case 'auth/user-not-found':
                            errorMessage = 'لا يوجد حساب بهذا البريد الإلكتروني';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'كلمة المرور غير صحيحة';
                            break;
                    }
                    return { success: false, error: errorMessage };
                }
            }

            async signup(userData) {
                try {
                    // Check if passwords match
                    if (userData.password !== userData.confirmPassword) {
                        return { success: false, error: 'كلمات المرور غير متطابقة' };
                    }

                    // Create user in Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        userData.email, 
                        userData.password
                    );

                    // Create user profile in Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        firstName: userData.firstName,
                        lastName: userData.lastName,
                        email: userData.email,
                        phone: userData.phone,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    return { success: true, user: userCredential.user };
                } catch (error) {
                    let errorMessage = 'حدث خطأ أثناء إنشاء الحساب';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'البريد الإلكتروني مسجل مسبقاً';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'البريد الإلكتروني غير صحيح';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = 'عملية التسجيل غير مسموحة';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل';
                            break;
                    }
                    return { success: false, error: errorMessage };
                }
            }

            async logout() {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            onAuthStateChanged(listener) {
                this.authStateListeners.push(listener);
            }

            showAuthScreen() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                this.updateUserInterface();
            }

            async updateUserInterface() {
                if (this.currentUser) {
                    // Get user profile from Firestore
                    const userDoc = await db.collection('users').doc(this.currentUser.uid).get();
                    const userData = userDoc.data();
                    
                    if (userData) {
                        const fullName = `${userData.firstName} ${userData.lastName}`;
                        const initials = (userData.firstName[0] + userData.lastName[0]).toUpperCase();
                        
                        document.getElementById('user-name').textContent = fullName;
                        document.getElementById('user-avatar').textContent = initials;
                        document.getElementById('menu-user-name').textContent = fullName;
                        document.getElementById('menu-user-email').textContent = this.currentUser.email;
                    }
                }
            }

            getCurrentUserId() {
                return this.currentUser ? this.currentUser.uid : null;
            }
        }

        // Firebase Data Management
        class FirebaseDataManager {
            constructor(authManager) {
                this.authManager = authManager;
                this.unsubscribeCallbacks = [];
            }

            // Buildings
            async addBuilding(building) {
                const userId = this.authManager.getCurrentUserId();
                const buildingRef = db.collection('users').doc(userId).collection('buildings').doc();
                
                const buildingData = {
                    ...building,
                    id: buildingRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await buildingRef.set(buildingData);
                return buildingData;
            }

            async getBuildings() {
                const userId = this.authManager.getCurrentUserId();
                const snapshot = await db.collection('users').doc(userId).collection('buildings')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            async updateBuilding(buildingId, updates) {
                const userId = this.authManager.getCurrentUserId();
                await db.collection('users').doc(userId).collection('buildings').doc(buildingId)
                    .update({
                        ...updates,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
            }

            async deleteBuilding(buildingId) {
                const userId = this.authManager.getCurrentUserId();
                await db.collection('users').doc(userId).collection('buildings').doc(buildingId).delete();
            }

            // Owners
            async addOwner(owner) {
                const userId = this.authManager.getCurrentUserId();
                const ownerRef = db.collection('users').doc(userId).collection('owners').doc();
                
                const ownerData = {
                    ...owner,
                    id: ownerRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await ownerRef.set(ownerData);
                return ownerData;
            }

            async getOwners(buildingId = null) {
                const userId = this.authManager.getCurrentUserId();
                let query = db.collection('users').doc(userId).collection('owners');
                
                if (buildingId) {
                    query = query.where('buildingId', '==', buildingId);
                }
                
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            async deleteOwner(ownerId) {
                const userId = this.authManager.getCurrentUserId();
                await db.collection('users').doc(userId).collection('owners').doc(ownerId).delete();
            }

            // Transactions
            async addTransaction(transaction) {
                const userId = this.authManager.getCurrentUserId();
                const transactionRef = db.collection('users').doc(userId).collection('transactions').doc();
                
                const transactionData = {
                    ...transaction,
                    id: transactionRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await transactionRef.set(transactionData);
                return transactionData;
            }

            async getTransactions(buildingId = null, monthFilter = '') {
                const userId = this.authManager.getCurrentUserId();
                let query = db.collection('users').doc(userId).collection('transactions');
                
                if (buildingId) {
                    query = query.where('buildingId', '==', buildingId);
                }
                
                const snapshot = await query.orderBy('date', 'desc').get();
                let transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Apply month filter if provided
                if (monthFilter) {
                    transactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        const transactionMonth = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                        return transactionMonth === monthFilter;
                    });
                }
                
                return transactions;
            }

            async deleteTransaction(transactionId) {
                const userId = this.authManager.getCurrentUserId();
                await db.collection('users').doc(userId).collection('transactions').doc(transactionId).delete();
            }

            // Real-time listeners
            onBuildingsChange(callback) {
                const userId = this.authManager.getCurrentUserId();
                const unsubscribe = db.collection('users').doc(userId).collection('buildings')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const buildings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(buildings);
                    });
                
                this.unsubscribeCallbacks.push(unsubscribe);
                return unsubscribe;
            }

            onOwnersChange(buildingId, callback) {
                const userId = this.authManager.getCurrentUserId();
                let query = db.collection('users').doc(userId).collection('owners');
                
                if (buildingId) {
                    query = query.where('buildingId', '==', buildingId);
                }
                
                const unsubscribe = query
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const owners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(owners);
                    });
                
                this.unsubscribeCallbacks.push(unsubscribe);
                return unsubscribe;
            }

            onTransactionsChange(buildingId, callback) {
                const userId = this.authManager.getCurrentUserId();
                let query = db.collection('users').doc(userId).collection('transactions');
                
                if (buildingId) {
                    query = query.where('buildingId', '==', buildingId);
                }
                
                const unsubscribe = query
                    .orderBy('date', 'desc')
                    .onSnapshot(snapshot => {
                        const transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        callback(transactions);
                    });
                
                this.unsubscribeCallbacks.push(unsubscribe);
                return unsubscribe;
            }

            // Cleanup listeners
            cleanup() {
                this.unsubscribeCallbacks.forEach(unsubscribe => unsubscribe());
                this.unsubscribeCallbacks = [];
            }
        }

        // Application Initialization
        class AppManager {
            constructor(authManager, dataManager) {
                this.authManager = authManager;
                this.dataManager = dataManager;
                this.currentBuildingId = null;
                this.buildings = [];
                this.owners = [];
                this.transactions = [];
                this.filteredTransactions = [];
                this.currentFilters = {};
            }

            async initApp() {
                try {
                    // Load buildings for the current user
                    await this.loadBuildings();
                    
                    // Set up real-time listeners
                    this.setupRealtimeListeners();
                    
                    // Initialize UI components
                    this.initializeUI();
                    
                    console.log('App initialized successfully');
                } catch (error) {
                    console.error('Error initializing app:', error);
                }
            }

            async loadBuildings() {
                try {
                    this.buildings = await this.dataManager.getBuildings();
                    this.populateBuildingSelect();
                    
                    // Auto-select first building if available
                    if (this.buildings.length > 0 && !this.currentBuildingId) {
                        this.currentBuildingId = this.buildings[0].id;
                        this.selectBuilding(this.currentBuildingId);
                    }
                } catch (error) {
                    console.error('Error loading buildings:', error);
                }
            }

            populateBuildingSelect() {
                buildingSelect.innerHTML = '<option value="">اختر العمارة...</option>';
                
                this.buildings.forEach(building => {
                    const option = document.createElement('option');
                    option.value = building.id;
                    option.textContent = building.buildingName || 'Unnamed Building';
                    option.selected = building.id === this.currentBuildingId;
                    buildingSelect.appendChild(option);
                });
            }

            async selectBuilding(buildingId) {
                this.currentBuildingId = buildingId;
                
                // Update UI
                const selectedBuilding = this.buildings.find(b => b.id === buildingId);
                if (selectedBuilding) {
                    document.getElementById('current-building').textContent = selectedBuilding.buildingName;
                }
                
                // Load building-specific data
                await this.loadBuildingData();
            }

            async loadBuildingData() {
                if (!this.currentBuildingId) return;
                
                try {
                    // Load owners and transactions for the current building
                    this.owners = await this.dataManager.getOwners(this.currentBuildingId);
                    this.transactions = await this.dataManager.getTransactions(this.currentBuildingId);
                    this.filteredTransactions = [...this.transactions];
                    
                    this.updateOwnersUI();
                    this.updateTransactionsUI();
                    this.updateStatsUI();
                    
                    // Ensure payment owner dropdown is updated
                    this.updatePaymentOwnerSelect();
                    this.updateFilterDropdowns();
                } catch (error) {
                    console.error('Error loading building data:', error);
                }
            }

            setupRealtimeListeners() {
                // Listen for buildings changes
                this.dataManager.onBuildingsChange((buildings) => {
                    this.buildings = buildings;
                    this.populateBuildingSelect();
                });

                // Listen for owners changes
                if (this.currentBuildingId) {
                    this.dataManager.onOwnersChange(this.currentBuildingId, (owners) => {
                        this.owners = owners;
                        this.updateOwnersUI();
                        this.updatePaymentOwnerSelect();
                        this.updateFilterDropdowns();
                    });

                    // Listen for transactions changes
                    this.dataManager.onTransactionsChange(this.currentBuildingId, (transactions) => {
                        this.transactions = transactions;
                        this.applyFilters();
                        this.updateTransactionsUI();
                        this.updateStatsUI();
                    });
                }
            }

            initializeUI() {
                // Set current date for payment form
                document.getElementById('payment-date').valueAsDate = new Date();
                
                // Initialize months grid for advance payments
                this.initializeMonthsGrid();
                
                // Update user interface
                this.updateStatsUI();
                
                // Initialize filter event listeners
                this.initializeFilters();
            }

            initializeFilters() {
                document.getElementById('apply-filters').addEventListener('click', () => {
                    this.applyFilters();
                });

                document.getElementById('reset-filters').addEventListener('click', () => {
                    this.resetFilters();
                });
            }

            applyFilters() {
                this.currentFilters = {
                    month: document.getElementById('month-filter').value,
                    owner: document.getElementById('owner-filter').value,
                    type: document.getElementById('type-filter').value,
                    category: document.getElementById('category-filter').value,
                    dateFrom: document.getElementById('date-from').value,
                    dateTo: document.getElementById('date-to').value
                };

                this.filteredTransactions = this.transactions.filter(transaction => {
                    let matches = true;

                    // Month filter
                    if (this.currentFilters.month) {
                        const transactionDate = new Date(transaction.date);
                        const transactionMonth = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                        matches = matches && transactionMonth === this.currentFilters.month;
                    }

                    // Owner filter
                    if (this.currentFilters.owner) {
                        matches = matches && transaction.owner === this.currentFilters.owner;
                    }

                    // Type filter
                    if (this.currentFilters.type) {
                        matches = matches && transaction.type === this.currentFilters.type;
                    }

                    // Category filter
                    if (this.currentFilters.category) {
                        matches = matches && transaction.category === this.currentFilters.category;
                    }

                    // Date range filter
                    if (this.currentFilters.dateFrom) {
                        matches = matches && new Date(transaction.date) >= new Date(this.currentFilters.dateFrom);
                    }

                    if (this.currentFilters.dateTo) {
                        matches = matches && new Date(transaction.date) <= new Date(this.currentFilters.dateTo);
                    }

                    return matches;
                });

                this.updateTransactionsUI();
            }

            resetFilters() {
                document.getElementById('month-filter').value = '';
                document.getElementById('owner-filter').value = '';
                document.getElementById('type-filter').value = '';
                document.getElementById('category-filter').value = '';
                document.getElementById('date-from').value = '';
                document.getElementById('date-to').value = '';
                
                this.currentFilters = {};
                this.filteredTransactions = [...this.transactions];
                this.updateTransactionsUI();
            }

            updateFilterDropdowns() {
                // Update owner filter dropdown
                const ownerFilter = document.getElementById('owner-filter');
                ownerFilter.innerHTML = '<option value="">جميع المالكين</option>';
                this.owners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner.name;
                    option.textContent = owner.name;
                    ownerFilter.appendChild(option);
                });

                // Update month filter dropdown
                const monthFilter = document.getElementById('month-filter');
                monthFilter.innerHTML = '<option value="">جميع الأشهر</option>';
                
                const months = new Set();
                this.transactions.forEach(transaction => {
                    const date = new Date(transaction.date);
                    const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(month);
                });

                Array.from(months).sort().reverse().forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                    option.textContent = `${monthNames[parseInt(monthNum) - 1]} ${year}`;
                    monthFilter.appendChild(option);
                });
            }

            initializeMonthsGrid() {
                const months = [
                    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                
                monthsGrid.innerHTML = '';
                months.forEach((month, index) => {
                    const checkbox = document.createElement('div');
                    checkbox.className = 'flex items-center space-x-2 space-x-reverse';
                    checkbox.innerHTML = `
                        <input type="checkbox" id="month-${index}" value="${index}" class="h-4 w-4 text-blue-600 rounded">
                        <label for="month-${index}" class="text-sm text-gray-700">${month}</label>
                    `;
                    monthsGrid.appendChild(checkbox);
                });
            }

            updatePaymentOwnerSelect() {
                const paymentOwnerSelect = document.getElementById('payment-owner-select');
                paymentOwnerSelect.innerHTML = '<option value="">اختر مالك الشقة</option>';
                
                this.owners.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner.name;
                    option.textContent = `${owner.name} - شقة ${owner.apartmentNumber || 'N/A'}`;
                    paymentOwnerSelect.appendChild(option);
                });
            }

            updateStatsUI() {
                // Calculate statistics
                const totalIncome = this.transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    
                const totalExpenses = this.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    
                const balance = totalIncome - totalExpenses;
                const ownersCount = this.owners.length;

                // Update stats container
                statsContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow-sm p-6 border-r-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">إجمالي الواردات</p>
                                <p class="text-2xl font-bold text-green-600">${totalIncome.toFixed(2)} د.أ</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6 border-r-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">إجمالي المصروفات</p>
                                <p class="text-2xl font-bold text-red-600">${totalExpenses.toFixed(2)} د.أ</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-receipt text-red-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6 border-r-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">صافي الرصيد</p>
                                <p class="text-2xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">
                                    ${balance.toFixed(2)} د.أ
                                </p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-balance-scale text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6 border-r-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">عدد المالكين</p>
                                <p class="text-2xl font-bold text-purple-600">${ownersCount}</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-users text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;
            }

            updateOwnersUI() {
                ownersCount.textContent = this.owners.length;
                
                if (this.owners.length === 0) {
                    ownersContainer.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-12">
                                <i class="fas fa-users text-gray-300 text-6xl mb-4"></i>
                                <p class="text-gray-500 text-lg">لا يوجد مالكين مسجلين</p>
                                <p class="text-gray-400 text-sm mt-2">إضغط على "إضافة مالك" لبدء التسجيل</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                ownersContainer.innerHTML = this.owners.map(owner => {
                    // Calculate owner statistics
                    const ownerTransactions = this.transactions.filter(t => t.owner === owner.name);
                    const totalPaid = ownerTransactions
                        .filter(t => t.type === 'income')
                        .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                    
                    const monthlySubscription = owner.subscription || 100;
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    
                    // Simple calculation for unpaid months (this can be enhanced)
                    const unpaidMonths = Math.max(0, Math.floor((monthlySubscription * 6 - totalPaid) / monthlySubscription));
                    
                    const totalDue = unpaidMonths * monthlySubscription;
                    const isLate = unpaidMonths > 0;

                    return `
                        <tr>
                            <td class="font-semibold">${owner.name || 'غير معروف'}</td>
                            <td>${owner.apartmentNumber || 'N/A'}</td>
                            <td>${owner.phone || 'N/A'}</td>
                            <td>${monthlySubscription} د.أ</td>
                            <td>${totalDue} د.أ</td>
                            <td>${totalPaid} د.أ</td>
                            <td>${unpaidMonths}</td>
                            <td>
                                <span class="${isLate ? 'status-late' : 'status-paid'}">
                                    ${isLate ? 'متأخر' : 'مستحق'}
                                </span>
                            </td>
                            <td>
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="appManager.showOwnerDetails('${owner.id}')" class="action-btn bg-blue-100 text-blue-700 hover:bg-blue-200">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="appManager.editOwner('${owner.id}')" class="action-btn bg-green-100 text-green-700 hover:bg-green-200">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="appManager.showOwnerTransactions('${owner.name}')" class="action-btn bg-purple-100 text-purple-700 hover:bg-purple-200">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                    <button onclick="appManager.deleteOwner('${owner.id}')" class="action-btn bg-red-100 text-red-700 hover:bg-red-200">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateTransactionsUI() {
                if (this.filteredTransactions.length === 0) {
                    transactionsContainer.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-12">
                                <i class="fas fa-receipt text-gray-300 text-6xl mb-4"></i>
                                <p class="text-gray-500 text-lg">لا توجد معاملات مسجلة</p>
                                <p class="text-gray-400 text-sm mt-2">إضغط على "إضافة دفعة" لتسجيل أول معاملة</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                transactionsContainer.innerHTML = this.filteredTransactions.map(transaction => {
                    const transactionDate = new Date(transaction.date);
                    const formattedDate = transactionDate.toLocaleDateString('ar-EG');
                    
                    return `
                        <tr>
                            <td>${formattedDate}</td>
                            <td>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                    transaction.type === 'income' 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-red-100 text-red-800'
                                }">
                                    <i class="fas ${
                                        transaction.type === 'income' ? 'fa-arrow-down' : 'fa-arrow-up'
                                    } mr-1"></i>
                                    ${transaction.type === 'income' ? 'واردات' : 'مصروفات'}
                                </span>
                            </td>
                            <td>${transaction.owner || 'عام'}</td>
                            <td>${transaction.description || 'لا يوجد وصف'}</td>
                            <td class="font-semibold ${
                                transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                            }">
                                ${transaction.type === 'income' ? '+' : '-'}${parseFloat(transaction.amount || 0).toFixed(2)} د.أ
                            </td>
                            <td>${transaction.category || 'غير مصنف'}</td>
                            <td>
                                ${transaction.notes ? 
                                    `<button onclick="appManager.showTransactionNotes('${transaction.id}')" class="action-btn bg-gray-100 text-gray-700 hover:bg-gray-200">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>` 
                                    : 'لا يوجد'
                                }
                            </td>
                            <td>
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="appManager.showTransactionDetails('${transaction.id}')" class="action-btn bg-blue-100 text-blue-700 hover:bg-blue-200">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="appManager.editTransaction('${transaction.id}')" class="action-btn bg-green-100 text-green-700 hover:bg-green-200">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="appManager.printReceipt('${transaction.id}')" class="action-btn bg-yellow-100 text-yellow-700 hover:bg-yellow-200">
                                        <i class="fas fa-print"></i>
                                    </button>
                                    <button onclick="appManager.shareReceipt('${transaction.id}')" class="action-btn bg-green-100 text-green-700 hover:bg-green-200">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                    <button onclick="appManager.deleteTransaction('${transaction.id}')" class="action-btn bg-red-100 text-red-700 hover:bg-red-200">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Action methods for transactions
            showTransactionDetails(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    alert(`تفاصيل المعاملة:\n\nالوصف: ${transaction.description}\nالمبلغ: ${transaction.amount} د.أ\nالنوع: ${transaction.type === 'income' ? 'واردات' : 'مصروفات'}\nالمالك: ${transaction.owner || 'عام'}\nالتاريخ: ${new Date(transaction.date).toLocaleDateString('ar-EG')}`);
                }
            }

            editTransaction(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    // Here you would open a modal to edit the transaction
                    alert(`تعديل المعاملة: ${transaction.description}`);
                    // Implement edit functionality
                }
            }

            printReceipt(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    // Implement print receipt functionality
                    alert(`طباعة إيصال للمعاملة: ${transaction.description}`);
                }
            }

            shareReceipt(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (transaction) {
                    // Implement WhatsApp sharing functionality
                    const message = `إيصال دفعة: ${transaction.description}\nالمبلغ: ${transaction.amount} د.أ\nالتاريخ: ${new Date(transaction.date).toLocaleDateString('ar-EG')}`;
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                }
            }

            showTransactionNotes(transactionId) {
                const transaction = this.transactions.find(t => t.id === transactionId);
                if (transaction && transaction.notes) {
                    alert(`ملاحظات المعاملة:\n\n${transaction.notes}`);
                }
            }

            async deleteTransaction(transactionId) {
                if (confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
                    try {
                        await this.dataManager.deleteTransaction(transactionId);
                        console.log('Transaction deleted successfully');
                    } catch (error) {
                        console.error('Error deleting transaction:', error);
                        alert('حدث خطأ أثناء حذف المعاملة');
                    }
                }
            }

            // Action methods for owners
            showOwnerDetails(ownerId) {
                const owner = this.owners.find(o => o.id === ownerId);
                if (owner) {
                    alert(`تفاصيل المالك:\n\nالاسم: ${owner.name}\nرقم الشقة: ${owner.apartmentNumber}\nالهاتف: ${owner.phone || 'N/A'}\nالاشتراك الشهري: ${owner.subscription || 100} د.أ`);
                }
            }

            editOwner(ownerId) {
                const owner = this.owners.find(o => o.id === ownerId);
                if (owner) {
                    // Here you would open a modal to edit the owner
                    alert(`تعديل بيانات المالك: ${owner.name}`);
                    // Implement edit functionality
                }
            }

            showOwnerTransactions(ownerName) {
                // Filter transactions by owner and show them
                const ownerTransactions = this.transactions.filter(t => t.owner === ownerName);
                if (ownerTransactions.length > 0) {
                    const transactionsList = ownerTransactions.map(t => 
                        `${new Date(t.date).toLocaleDateString('ar-EG')} - ${t.description} - ${t.amount} د.أ`
                    ).join('\n');
                    alert(`معاملات ${ownerName}:\n\n${transactionsList}`);
                } else {
                    alert(`لا توجد معاملات مسجلة لـ ${ownerName}`);
                }
            }

            async deleteOwner(ownerId) {
                if (confirm('هل أنت متأكد من حذف هذا المالك؟ سيتم حذف جميع معاملاته المرتبطة به.')) {
                    try {
                        await this.dataManager.deleteOwner(ownerId);
                        console.log('Owner deleted successfully');
                    } catch (error) {
                        console.error('Error deleting owner:', error);
                        alert('حدث خطأ أثناء حذف المالك');
                    }
                }
            }
        }

        // Initialize Managers
        const authManager = new FirebaseAuthManager();
        const dataManager = new FirebaseDataManager(authManager);
        const appManager = new AppManager(authManager, dataManager);

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');
        const addBuildingBtn = document.getElementById('add-building-btn');
        const addOwnerBtn = document.getElementById('add-owner-btn');
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const addBuildingModal = document.getElementById('add-building-modal');
        const addOwnerModal = document.getElementById('add-owner-modal');
        const addPaymentModal = document.getElementById('add-payment-modal');
        const receiptModal = document.getElementById('receipt-modal');
        const cancelBuildingBtn = document.getElementById('cancel-building-btn');
        const cancelOwnerBtn = document.getElementById('cancel-owner-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const closeReceiptBtn = document.getElementById('close-receipt-btn');
        const printReceiptBtn = document.getElementById('print-receipt-btn');
        const shareReceiptBtn = document.getElementById('share-receipt-btn');
        const buildingSelect = document.getElementById('building-select');
        const paymentOwnerSelect = document.getElementById('payment-owner-select');
        const advancePaymentCheckbox = document.getElementById('advance-payment-checkbox');
        const monthsSelection = document.getElementById('months-selection');
        const monthsGrid = document.getElementById('months-grid');
        const statsContainer = document.getElementById('stats-container');
        const transactionsContainer = document.getElementById('transactions-container');
        const ownersContainer = document.getElementById('owners-container');
        const ownersCount = document.getElementById('owners-count');
        const tabPayments = document.getElementById('tab-payments');
        const tabOwners = document.getElementById('tab-owners');
        const paymentsTab = document.getElementById('payments-tab');
        const ownersTab = document.getElementById('owners-tab');
        const monthFilter = document.getElementById('month-filter');

        // Authentication Event Listeners
        showSignupBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('signup-error').classList.add('hidden');
            document.getElementById('signup-success').classList.add('hidden');
        });

        showLoginBtn.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');

            const loginBtn = document.getElementById('login-btn');
            const loginText = document.getElementById('login-text');
            const loginSpinner = document.getElementById('login-spinner');
            const loginError = document.getElementById('login-error');

            // Show loading state
            loginText.textContent = 'جاري تسجيل الدخول...';
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            loginError.classList.add('hidden');

            try {
                const result = await authManager.login(email, password);
                if (!result.success) {
                    loginError.textContent = result.error;
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                loginError.textContent = 'حدث خطأ أثناء تسجيل الدخول';
                loginError.classList.remove('hidden');
            } finally {
                // Reset button state
                loginText.textContent = 'تسجيل الدخول';
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                phone: formData.get('phone')
            };

            const signupBtn = document.getElementById('signup-btn');
            const signupText = document.getElementById('signup-text');
            const signupSpinner = document.getElementById('signup-spinner');
            const signupError = document.getElementById('signup-error');
            const signupSuccess = document.getElementById('signup-success');

            // Show loading state
            signupText.textContent = 'جاري إنشاء الحساب...';
            signupSpinner.classList.remove('hidden');
            signupBtn.disabled = true;
            signupError.classList.add('hidden');
            signupSuccess.classList.add('hidden');

            try {
                const result = await authManager.signup(userData);
                if (result.success) {
                    signupSuccess.textContent = 'تم إنشاء الحساب بنجاح! جاري تسجيل الدخول...';
                    signupSuccess.classList.remove('hidden');
                } else {
                    signupError.textContent = result.error;
                    signupError.classList.remove('hidden');
                }
            } catch (error) {
                signupError.textContent = 'حدث خطأ أثناء إنشاء الحساب';
                signupError.classList.remove('hidden');
            } finally {
                // Reset button state
                signupText.textContent = 'إنشاء حساب';
                signupSpinner.classList.add('hidden');
                signupBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', () => {
            authManager.logout();
            dataManager.cleanup();
        });

        // Initialize the app when auth state changes
        authManager.onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                // Initialize the main application
                setTimeout(() => {
                    appManager.initApp();
                }, 1000);
            } else {
                console.log('User signed out');
                // Clean up when user signs out
                dataManager.cleanup();
            }
        });

        // Building selection
        buildingSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                appManager.selectBuilding(e.target.value);
            }
        });

        // Modal toggle functionality
        addBuildingBtn.addEventListener('click', () => {
            addBuildingModal.classList.remove('hidden');
        });

        addOwnerBtn.addEventListener('click', () => {
            addOwnerModal.classList.remove('hidden');
        });

        addPaymentBtn.addEventListener('click', () => {
            addPaymentModal.classList.remove('hidden');
        });

        // Modal close functionality
        cancelBuildingBtn.addEventListener('click', () => {
            addBuildingModal.classList.add('hidden');
        });

        cancelOwnerBtn.addEventListener('click', () => {
            addOwnerModal.classList.add('hidden');
        });

        cancelPaymentBtn.addEventListener('click', () => {
            addPaymentModal.classList.add('hidden');
        });

        closeReceiptBtn.addEventListener('click', () => {
            receiptModal.classList.add('hidden');
        });

        // User menu toggle
        userMenuBtn.addEventListener('click', () => {
            userMenu.classList.toggle('hidden');
        });

        // Tab switching
        tabPayments.addEventListener('click', () => {
            tabPayments.classList.add('tab-active');
            tabPayments.classList.remove('bg-gray-100', 'text-gray-600');
            tabOwners.classList.remove('tab-active');
            tabOwners.classList.add('bg-gray-100', 'text-gray-600');
            paymentsTab.classList.remove('hidden');
            ownersTab.classList.add('hidden');
        });

        tabOwners.addEventListener('click', () => {
            tabOwners.classList.add('tab-active');
            tabOwners.classList.remove('bg-gray-100', 'text-gray-600');
            tabPayments.classList.remove('tab-active');
            tabPayments.classList.add('bg-gray-100', 'text-gray-600');
            ownersTab.classList.remove('hidden');
            paymentsTab.classList.add('hidden');
        });

        // Advance payment toggle
        advancePaymentCheckbox.addEventListener('change', (e) => {
            monthsSelection.classList.toggle('hidden', !e.target.checked);
        });

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!userMenuBtn.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // Add Building Form
        document.getElementById('add-building-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const building = {
                    buildingName: formData.get('buildingName'),
                    buildingAddress: formData.get('buildingAddress'),
                    unitsCount: parseInt(formData.get('unitsCount')) || 0,
                    notes: formData.get('notes')
                };
                
                await dataManager.addBuilding(building);
                addBuildingModal.classList.add('hidden');
                e.target.reset();
                
                // Show success message or update UI
                console.log('Building added successfully');
            } catch (error) {
                console.error('Error adding building:', error);
                alert('حدث خطأ أثناء إضافة العمارة');
            }
        });

        // Add Owner Form
        document.getElementById('add-owner-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (!appManager.currentBuildingId) {
                alert('يرجى اختيار عمارة أولاً');
                return;
            }
            
            try {
                const owner = {
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    apartmentNumber: formData.get('apartmentNumber'),
                    floor: formData.get('floor'),
                    direction: formData.get('direction'),
                    subscription: parseFloat(formData.get('subscription')) || 100,
                    notes: formData.get('notes'),
                    buildingId: appManager.currentBuildingId
                };
                
                await dataManager.addOwner(owner);
                addOwnerModal.classList.add('hidden');
                e.target.reset();
                
                console.log('Owner added successfully');
            } catch (error) {
                console.error('Error adding owner:', error);
                alert('حدث خطأ أثناء إضافة المالك');
            }
        });

        // Add Payment Form
        document.getElementById('add-payment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (!appManager.currentBuildingId) {
                alert('يرجى اختيار عمارة أولاً');
                return;
            }
            
            if (!formData.get('owner')) {
                alert('يرجى اختيار مالك الشقة');
                return;
            }
            
            try {
                const transaction = {
                    type: formData.get('type'),
                    amount: parseFloat(formData.get('amount')) || 0,
                    description: formData.get('description'),
                    owner: formData.get('owner'),
                    date: formData.get('date') || new Date().toISOString().split('T')[0],
                    category: formData.get('category'),
                    notes: formData.get('notes'),
                    buildingId: appManager.currentBuildingId
                };
                
                await dataManager.addTransaction(transaction);
                addPaymentModal.classList.add('hidden');
                e.target.reset();
                
                console.log('Transaction added successfully');
            } catch (error) {
                console.error('Error adding transaction:', error);
                alert('حدث خطأ أثناء إضافة الدفعة');
            }
        });

        // Offline/Online detection
        firebase.database().ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                document.getElementById('offline-indicator').style.display = 'none';
            } else {
                document.getElementById('offline-indicator').style.display = 'block';
            }
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/bsakan-app/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
