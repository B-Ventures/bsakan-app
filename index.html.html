<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B Sakan - إدارة مصروفات العمارات</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="B Sakan">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="B Sakan">
    <meta name="description" content="برنامج متكامل لإدارة العمارات والمصروفات">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3b82f6">

    <!-- Icons -->
    <link rel="icon" type="image/png" href="assets/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .receipt-print {
                border: 2px solid #000 !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            @page {
                margin: 0;
                size: auto;
            }
        }
        
        .receipt-border {
            border: 2px solid #000;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 120px;
        }
        
        .auth-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-bg flex items-center justify-center p-4 min-h-screen">
        <div class="auth-card w-full max-w-md p-8 fade-in">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl ml-3">
                        B
                    </div>
                    <span class="text-3xl font-bold text-gray-800">Sakan</span>
                </div>
                <p class="text-gray-600">برنامج متكامل لإدارة العمارات والمصروفات</p>
                <p class="text-sm text-gray-500 mt-2">شركة B Ventures LLC</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">تسجيل الدخول</h2>
                
                <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        البريد الإلكتروني
                    </label>
                    <input
                        type="email"
                        name="email"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل بريدك الإلكتروني"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل كلمة المرور"
                        required
                    />
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center space-x-2 space-x-reverse">
                        <input type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                        <span class="text-sm text-gray-600">تذكرني</span>
                    </label>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-800">نسيت كلمة المرور؟</a>
                </div>
                
                <button
                    type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold flex items-center justify-center"
                    id="login-btn"
                >
                    <span id="login-text">تسجيل الدخول</span>
                    <div id="login-spinner" class="loading-spinner hidden mr-2"></div>
                </button>
                
                <div class="text-center">
                    <p class="text-gray-600">
                        ليس لديك حساب؟ 
                        <button type="button" id="show-signup" class="text-blue-600 hover:text-blue-800 font-semibold">
                            سجل الآن
                        </button>
                    </p>
                </div>
            </form>

            <!-- Signup Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">إنشاء حساب جديد</h2>
                
                <div id="signup-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                <div id="signup-success" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            الاسم الأول
                        </label>
                        <input
                            type="text"
                            name="firstName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="الاسم الأول"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            اسم العائلة
                        </label>
                        <input
                            type="text"
                            name="lastName"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="اسم العائلة"
                            required
                        />
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        البريد الإلكتروني
                    </label>
                    <input
                        type="email"
                        name="email"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ادخل بريدك الإلكتروني"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="اختر كلمة مرور قوية"
                        required
                        minlength="6"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        تأكيد كلمة المرور
                    </label>
                    <input
                        type="password"
                        name="confirmPassword"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="أعد إدخال كلمة المرور"
                        required
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        رقم الهاتف
                    </label>
                    <input
                        type="tel"
                        name="phone"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="رقم الهاتف"
                    />
                </div>
                
                <div class="flex items-center">
                    <input
                        type="checkbox"
                        name="agreeTerms"
                        class="h-4 w-4 text-blue-600 rounded ml-2"
                        required
                    />
                    <label class="text-sm text-gray-600">
                        أوافق على 
                        <a href="#" class="text-blue-600 hover:text-blue-800">الشروط والأحكام</a>
                        و
                        <a href="#" class="text-blue-600 hover:text-blue-800">سياسة الخصوصية</a>
                    </label>
                </div>
                
                <button
                    type="submit"
                    class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center justify-center"
                    id="signup-btn"
                >
                    <span id="signup-text">إنشاء حساب</span>
                    <div id="signup-spinner" class="loading-spinner hidden mr-2"></div>
                </button>
                
                <div class="text-center">
                    <p class="text-gray-600">
                        لديك حساب بالفعل؟ 
                        <button type="button" id="show-login" class="text-blue-600 hover:text-blue-800 font-semibold">
                            سجل الدخول
                        </button>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application (Hidden until authenticated) -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="text-center md:text-right">
                        <h1 class="text-2xl font-bold text-gray-800">برنامج B Sakan لإدارة مصروفات العمارات</h1>
                        <div class="flex items-center justify-center md:justify-start space-x-2 space-x-reverse mt-1">
                            <select id="building-select" class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر العمارة...</option>
                            </select>
                            <p class="text-gray-600 text-sm" id="current-building">عمارة السالم 12</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <div class="flex space-x-3 space-x-reverse flex-wrap justify-center gap-2">
                            <button id="add-building-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-building mr-1"></i> إضافة عمارة
                            </button>
                            <button id="add-owner-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-user-plus mr-1"></i> إضافة مالك
                            </button>
                            <button id="add-payment-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-money-bill-wave mr-1"></i> إضافة دفعة
                            </button>
                        </div>
                        <div class="relative">
                            <button id="user-menu-btn" class="flex items-center space-x-2 space-x-reverse bg-gray-100 rounded-lg px-3 py-2 hover:bg-gray-200 transition-colors">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm" id="user-avatar">
                                    U
                                </div>
                                <span class="text-sm font-medium text-gray-700" id="user-name">المستخدم</span>
                                <i class="fas fa-chevron-down text-gray-500 text-xs"></i>
                            </button>
                            <div id="user-menu" class="dropdown-menu hidden mt-2 right-0">
                                <div class="px-4 py-2 border-b border-gray-200">
                                    <p class="text-sm font-medium text-gray-800" id="menu-user-name">المستخدم</p>
                                    <p class="text-xs text-gray-500" id="menu-user-email">user@example.com</p>
                                </div>
                                <button class="w-full text-right px-4 py-2 hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-cog mr-2"></i> الإعدادات
                                </button>
                                <button id="logout-btn" class="w-full text-right px-4 py-2 hover:bg-gray-100 text-red-600">
                                    <i class="fas fa-sign-out-alt mr-2"></i> تسجيل الخروج
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-container">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <!-- Tabs Section -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="flex space-x-2 space-x-reverse w-full md:w-auto">
                        <button id="tab-payments" class="tab-active px-4 py-2 rounded-lg transition-colors">
                            المعاملات
                        </button>
                        <button id="tab-owners" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            المالكين (<span id="owners-count">0</span>)
                        </button>
                    </div>
                    
                    <div class="flex space-x-2 space-x-reverse w-full md:w-auto justify-center">
                        <select id="month-filter" class="bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">جميع الأشهر</option>
                        </select>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            تصفية الحساب الشهري
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Payments Tab Content -->
            <div id="payments-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="transactions-container">
                    <!-- Transactions will be loaded dynamically -->
                </div>
            </div>
            
            <!-- Owners Tab Content -->
            <div id="owners-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="owners-container">
                    <!-- Owners will be loaded dynamically -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-8">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">عن البرنامج</h3>
                        <p class="text-gray-300">برنامج B Sakan لإدارة العمارات والمصروفات</p>
                        <p class="text-gray-300 mt-2">شركة B Ventures LLC</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">روابط سريعة</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><a href="#" class="hover:text-white transition-colors">الدعم الفني</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الشروط والأحكام</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الأسئلة الشائعة</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">اتصل بنا</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><i class="fas fa-envelope mr-2"></i> info@bsakan.com</li>
                            <li><i class="fas fa-phone mr-2"></i> +218-91-123-4567</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">تابعنا</h3>
                        <div class="flex space-x-4 space-x-reverse">
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-4 text-center text-gray-400">
                    <p>© 2025 برنامج B Sakan. جميع الحقوق محفوظة. شركة B Ventures LLC</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Building Modal -->
    <div id="add-building-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة عمارة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل العمارة الجديدة</p>
                
                <form id="add-building-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم العمارة *
                        </label>
                        <input
                            type="text"
                            name="buildingName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل اسم العمارة"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            العنوان
                        </label>
                        <input
                            type="text"
                            name="buildingAddress"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل عنوان العمارة"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            عدد الوحدات
                        </label>
                        <input
                            type="number"
                            name="unitsCount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="عدد الوحدات السكنية"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            إضافة العمارة
                        </button>
                        <button
                            type="button"
                            id="cancel-building-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="add-owner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة مالك جديد</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل مالك الشقة الجديد</p>
                
                <form id="add-owner-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم المالك *
                        </label>
                        <input
                            type="text"
                            name="name"
                            class="w-full px-3 py-2 border border-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="أدخل اسم المالك"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            رقم الهاتف
                        </label>
                        <input
                            type="tel"
                            name="phone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="0791234567"
                        />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                رقم الشقة
                            </label>
                            <input
                                type="text"
                                name="apartmentNumber"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="1"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                الطابق
                            </label>
                            <input
                                type="text"
                                name="floor"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="الأول"
                            />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اتجاه الشقة
                        </label>
                        <select
                            name="direction"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">اختر اتجاه الشقة</option>
                            <option value="north">شمال</option>
                            <option value="south">جنوب</option>
                            <option value="east">شرق</option>
                            <option value="west">غرب</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            الاشتراك الشهري (د.أ)
                        </label>
                        <input
                            type="number"
                            name="subscription"
                            value="100.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة المالك
                        </button>
                        <button
                            type="button"
                            id="cancel-owner-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة دفعة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل الدفعة الجديدة سواء كانت واردات أو مصروفات</p>
                
                <form id="add-payment-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            نوع الدفعة
                        </label>
                        <select
                            name="type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="income">واردات</option>
                            <option value="expense">مصروفات</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            المبلغ (د.أ)
                        </label>
                        <input
                            type="number"
                            name="amount"
                            value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            وصف الدفعة
                        </label>
                        <input
                            type="text"
                            name="description"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="مثالاً: اشتراك شقة رقم 1 أو أجرة سباك"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            مالك الشقة *
                        </label>
                        <select
                            name="owner"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                            id="payment-owner-select"
                        >
                            <option value="">اختر مالك الشقة</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            تاريخ الدفعة
                        </label>
                        <input
                            type="date"
                            name="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            id="payment-date"
                        />
                    </div>
                    
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <input
                            type="checkbox"
                            name="advancePayment"
                            class="h-4 w-4 text-blue-600 rounded"
                            id="advance-payment-checkbox"
                        />
                        <label for="advance-payment-checkbox" class="text-sm font-medium text-gray-700">
                            دفعة مقدمة لعدة شهور
                        </label>
                    </div>
                    
                    <div id="months-selection" class="bg-gray-50 p-4 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">اختر الشهور المدفوعة</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2" id="months-grid">
                            <!-- Months will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة الدفعة
                        </button>
                        <button
                            type="button"
                            id="cancel-payment-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md receipt-border receipt-print" style="max-width: 500px;">
            <div class="p-6">
                <!-- Header -->
                <div class="text-center mb-6">
                    <div class="flex items-center justify-center mb-2">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg ml-2">
                            B
                        </div>
                        <span class="text-xl font-bold">Sakan</span>
                    </div>
                    <p class="text-gray-600 text-sm">شركة B Ventures LLC</p>
                    <h1 class="text-lg font-bold mt-2">برنامج B Sakan لإدارة وإصلاح ومصروفات العمارات</h1>
                    <p class="text-red-500 font-semibold" id="receipt-building-name">عمارة السالم 12</p>
                </div>
                
                <!-- Receipt Details -->
                <div class="border-t border-b border-gray-300 py-4 mb-4">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">سند قبض</h2>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">رقم السند:</span>
                            <span id="receipt-number">50</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">التاريخ:</span>
                            <span id="receipt-date">10-16-2025 م (1447-04-24 هـ)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">وصف الدفعة:</span>
                            <span id="receipt-description">تأمين للعمارة</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">اسم المستفيد:</span>
                            <span id="receipt-resident">محمد أحمد</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">رقم الشقة:</span>
                            <span id="receipt-unit">1</span>
                        </div>
                        <div class="flex justify-between" id="receipt-months-container">
                            <!-- Months will be added here if advance payment -->
                        </div>
                    </div>
                </div>
                
                <!-- Amount Section -->
                <div class="border-2 border-green-500 rounded-lg p-4 mb-6 text-center">
                    <p class="text-gray-600 mb-2">المبلغ المستلم</p>
                    <p class="text-green-600 text-3xl font-bold" id="receipt-amount">50 دينار أردني</p>
                </div>
                
                <!-- Footer -->
                <div class="text-center text-gray-600 text-sm">
                    <p class="font-medium mb-2">ملاحظات:</p>
                    <p class="mb-4" id="receipt-notes">قسط التامين السنوي</p>
                    <div class="flex items-center justify-center">
                        <span>www.bsakan.com</span>
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                    </div>
                </div>
                
                <div class="mt-6 text-center flex space-x-3 space-x-reverse justify-center no-print">
                    <button id="print-receipt-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-print mr-1"></i> طباعة
                    </button>
                    <button id="share-receipt-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fab fa-whatsapp mr-1"></i> مشاركة عبر واتساب
                    </button>
                    <button id="close-receipt-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Authentication System
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.users = this.loadFromStorage('users') || [];
                this.checkAuthStatus();
            }

            loadFromStorage(key) {
                const data = localStorage.getItem(`bsakan_${key}`);
                return data ? JSON.parse(data) : null;
            }

            saveToStorage(key, data) {
                localStorage.setItem(`bsakan_${key}`, JSON.stringify(data));
            }

            checkAuthStatus() {
                const savedUser = this.loadFromStorage('currentUser');
                if (savedUser && savedUser.token) {
                    this.currentUser = savedUser;
                    this.showMainApp();
                } else {
                    this.showAuthScreen();
                }
            }

            showAuthScreen() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                this.updateUserInterface();
            }

            async login(email, password) {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const user = this.users.find(u => u.email === email && u.password === password);
                if (user) {
                    const userData = {
                        id: user.id,
                        email: user.email,
                        firstName: user.firstName,
                        lastName: user.lastName,
                        phone: user.phone,
                        token: this.generateToken(),
                        loginTime: new Date().toISOString()
                    };
                    
                    this.currentUser = userData;
                    this.saveToStorage('currentUser', userData);
                    this.showMainApp();
                    return { success: true, user: userData };
                } else {
                    return { success: false, error: 'البريد الإلكتروني أو كلمة المرور غير صحيحة' };
                }
            }

            async signup(userData) {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check if user already exists
                if (this.users.find(u => u.email === userData.email)) {
                    return { success: false, error: 'البريد الإلكتروني مسجل مسبقاً' };
                }

                // Check password match
                if (userData.password !== userData.confirmPassword) {
                    return { success: false, error: 'كلمات المرور غير متطابقة' };
                }

                // Create new user
                const newUser = {
                    id: Date.now(),
                    email: userData.email,
                    password: userData.password,
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    phone: userData.phone,
                    createdAt: new Date().toISOString()
                };

                this.users.push(newUser);
                this.saveToStorage('users', this.users);

                // Auto login after signup
                return this.login(userData.email, userData.password);
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('bsakan_currentUser');
                this.showAuthScreen();
            }

            generateToken() {
                return 'token_' + Math.random().toString(36).substr(2) + Date.now().toString(36);
            }

            updateUserInterface() {
                if (this.currentUser) {
                    const fullName = `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                    const initials = (this.currentUser.firstName[0] + this.currentUser.lastName[0]).toUpperCase();
                    
                    document.getElementById('user-name').textContent = fullName;
                    document.getElementById('user-avatar').textContent = initials;
                    document.getElementById('menu-user-name').textContent = fullName;
                    document.getElementById('menu-user-email').textContent = this.currentUser.email;
                }
            }

            getCurrentUserId() {
                return this.currentUser ? this.currentUser.id : null;
            }
        }

        // Data Management (Updated for user-specific data)
        class DataManager {
            constructor(authManager) {
                this.authManager = authManager;
                this.userData = this.loadUserData();
            }

            getUserKey() {
                const userId = this.authManager.getCurrentUserId();
                return userId ? `user_${userId}` : 'anonymous';
            }

            loadUserData() {
                const userKey = this.getUserKey();
                const data = localStorage.getItem(`bsakan_data_${userKey}`);
                
                if (data) {
                    return JSON.parse(data);
                } else {
                    // Initialize with default data for new users
                    return {
                        buildings: [
                            { id: 1, name: 'عمارة السالم 12', address: 'شارع السالم', units: 12, notes: '' }
                        ],
                        owners: [],
                        transactions: [],
                        currentBuildingId: 1
                    };
                }
            }

            saveUserData() {
                const userKey = this.getUserKey();
                localStorage.setItem(`bsakan_data_${userKey}`, JSON.stringify(this.userData));
            }

            // Buildings
            addBuilding(building) {
                building.id = Date.now();
                this.userData.buildings.push(building);
                this.saveUserData();
                return building;
            }

            getCurrentBuilding() {
                return this.userData.buildings.find(b => b.id === this.userData.currentBuildingId) || this.userData.buildings[0];
            }

            setCurrentBuilding(buildingId) {
                this.userData.currentBuildingId = buildingId;
                this.saveUserData();
            }

            // Owners
            addOwner(owner) {
                owner.id = Date.now();
                owner.buildingId = this.userData.currentBuildingId;
                this.userData.owners.push(owner);
                this.saveUserData();
                return owner;
            }

            getBuildingOwners() {
                return this.userData.owners.filter(owner => owner.buildingId === this.userData.currentBuildingId);
            }

            deleteOwner(ownerId) {
                this.userData.owners = this.userData.owners.filter(owner => owner.id !== ownerId);
                this.saveUserData();
            }

            // Transactions
            addTransaction(transaction) {
                transaction.id = Date.now();
                transaction.buildingId = this.userData.currentBuildingId;
                transaction.createdAt = new Date().toISOString();
                this.userData.transactions.push(transaction);
                this.saveUserData();
                return transaction;
            }

            getBuildingTransactions(monthFilter = '') {
                let transactions = this.userData.transactions.filter(t => t.buildingId === this.userData.currentBuildingId);
                
                if (monthFilter) {
                    transactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        const transactionMonth = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                        return transactionMonth === monthFilter;
                    });
                }
                
                return transactions;
            }

            deleteTransaction(transactionId) {
                this.userData.transactions = this.userData.transactions.filter(t => t.id !== transactionId);
                this.saveUserData();
            }

            getBuildingStats(monthFilter = '') {
                const buildingTransactions = this.getBuildingTransactions(monthFilter);
                const income = buildingTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expenses = buildingTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expenses;
                const transactionCount = buildingTransactions.length;

                return {
                    balance: balance.toFixed(2),
                    income: income.toFixed(2),
                    expenses: expenses.toFixed(2),
                    transactionCount
                };
            }

            getAvailableMonths() {
                const months = new Set();
                this.getBuildingTransactions().forEach(transaction => {
                    const date = new Date(transaction.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = this.getMonthName(date);
                    months.add(`${monthKey}|${monthName}`);
                });
                return Array.from(months).sort().map(m => {
                    const [key, name] = m.split('|');
                    return { key, name };
                });
            }

            getMonthName(date) {
                const months = [
                    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                return months[date.getMonth()];
            }
        }

        // Initialize Managers
        const authManager = new AuthManager();
        const dataManager = new DataManager(authManager);

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const logoutBtn = document.getElementById('logout-btn');
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');

        // Existing DOM elements from your app
        const addBuildingBtn = document.getElementById('add-building-btn');
        const addOwnerBtn = document.getElementById('add-owner-btn');
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const addBuildingModal = document.getElementById('add-building-modal');
        const addOwnerModal = document.getElementById('add-owner-modal');
        const addPaymentModal = document.getElementById('add-payment-modal');
        const receiptModal = document.getElementById('receipt-modal');
        const cancelBuildingBtn = document.getElementById('cancel-building-btn');
        const cancelOwnerBtn = document.getElementById('cancel-owner-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const closeReceiptBtn = document.getElementById('close-receipt-btn');
        const printReceiptBtn = document.getElementById('print-receipt-btn');
        const shareReceiptBtn = document.getElementById('share-receipt-btn');
        const buildingSelect = document.getElementById('building-select');
        const paymentOwnerSelect = document.getElementById('payment-owner-select');
        const advancePaymentCheckbox = document.getElementById('advance-payment-checkbox');
        const monthsSelection = document.getElementById('months-selection');
        const monthsGrid = document.getElementById('months-grid');
        const statsContainer = document.getElementById('stats-container');
        const transactionsContainer = document.getElementById('transactions-container');
        const ownersContainer = document.getElementById('owners-container');
        const ownersCount = document.getElementById('owners-count');
        const tabPayments = document.getElementById('tab-payments');
        const tabOwners = document.getElementById('tab-owners');
        const paymentsTab = document.getElementById('payments-tab');
        const ownersTab = document.getElementById('owners-tab');
        const monthFilter = document.getElementById('month-filter');

        // Authentication Event Listeners
        showSignupBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            document.getElementById('signup-error').classList.add('hidden');
            document.getElementById('signup-success').classList.add('hidden');
        });

        showLoginBtn.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');

            const loginBtn = document.getElementById('login-btn');
            const loginText = document.getElementById('login-text');
            const loginSpinner = document.getElementById('login-spinner');
            const loginError = document.getElementById('login-error');

            // Show loading state
            loginText.textContent = 'جاري تسجيل الدخول...';
            loginSpinner.classList.remove('hidden');
            loginBtn.disabled = true;
            loginError.classList.add('hidden');

            try {
                const result = await authManager.login(email, password);
                if (result.success) {
                    // Login successful - app will automatically show
                } else {
                    loginError.textContent = result.error;
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                loginError.textContent = 'حدث خطأ أثناء تسجيل الدخول';
                loginError.classList.remove('hidden');
            } finally {
                // Reset button state
                loginText.textContent = 'تسجيل الدخول';
                loginSpinner.classList.add('hidden');
                loginBtn.disabled = false;
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                phone: formData.get('phone')
            };

            const signupBtn = document.getElementById('signup-btn');
            const signupText = document.getElementById('signup-text');
            const signupSpinner = document.getElementById('signup-spinner');
            const signupError = document.getElementById('signup-error');
            const signupSuccess = document.getElementById('signup-success');

            // Show loading state
            signupText.textContent = 'جاري إنشاء الحساب...';
            signupSpinner.classList.remove('hidden');
            signupBtn.disabled = true;
            signupError.classList.add('hidden');
            signupSuccess.classList.add('hidden');

            try {
                const result = await authManager.signup(userData);
                if (result.success) {
                    signupSuccess.textContent = 'تم إنشاء الحساب بنجاح! جاري تسجيل الدخول...';
                    signupSuccess.classList.remove('hidden');
                    // Auto-redirect will happen
                } else {
                    signupError.textContent = result.error;
                    signupError.classList.remove('hidden');
                }
            } catch (error) {
                signupError.textContent = 'حدث خطأ أثناء إنشاء الحساب';
                signupError.classList.remove('hidden');
            } finally {
                // Reset button state
                signupText.textContent = 'إنشاء حساب';
                signupSpinner.classList.add('hidden');
                signupBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener('click', () => {
            authManager.logout();
        });

        userMenuBtn.addEventListener('click', () => {
            userMenu.classList.toggle('hidden');
        });

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!userMenuBtn.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });

        // ALL YOUR EXISTING APPLICATION CODE CONTINUES HERE...
        // [The rest of your existing JavaScript code for buildings, owners, payments, etc.]
        // This includes: initApp(), loadBuildings(), loadStats(), loadTransactions(), etc.
        // I have to truncate here due to length, but the complete code would include all your existing functionality

        // Initialize the main app when authenticated
        function initApp() {
            if (authManager.currentUser) {
                // Initialize all your existing app functionality
                loadBuildings();
                loadStats();
                loadTransactions();
                loadOwners();
                loadMonthFilter();
                setupEventListeners();
                setupMonthsGrid();
                setCurrentDate();
            }
        }

        // Call initApp when the page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // ... [Rest of your existing application JavaScript code]

    </script>
</body>
</html>
