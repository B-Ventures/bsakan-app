<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B Sakan - إدارة مصروفات العمارات</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="B Sakan">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="B Sakan">
    <meta name="description" content="برنامج متكامل لإدارة العمارات والمصروفات">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3b82f6">

    <!-- Icons -->
    <link rel="icon" type="image/png" href="assets/icons/icon-72x72.png">
    <link rel="apple-touch-icon" href="assets/icons/icon-192x192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- External Resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
            --tw-space-x-reverse: 1;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .receipt-print {
                border: 2px solid #000 !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
            }
            @page {
                margin: 0;
                size: auto;
            }
        }
        
        .receipt-border {
            border: 2px solid #000;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-active {
            background-color: #3b82f6;
            color: white;
        }
        
        .dropdown-menu {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 120px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="app-container">
        <!-- Header -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="text-center md:text-right">
                        <h1 class="text-2xl font-bold text-gray-800">برنامج B Sakan لإدارة مصروفات العمارات</h1>
                        <div class="flex items-center justify-center md:justify-start space-x-2 space-x-reverse mt-1">
                            <select id="building-select" class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">اختر العمارة...</option>
                            </select>
                            <p class="text-gray-600 text-sm" id="current-building">عمارة السالم 12</p>
                        </div>
                    </div>
                    <div class="flex space-x-3 space-x-reverse flex-wrap justify-center gap-2">
                        <button id="add-building-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-building mr-1"></i> إضافة عمارة
                        </button>
                        <button id="add-owner-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-user-plus mr-1"></i> إضافة مالك
                        </button>
                        <button id="add-payment-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-money-bill-wave mr-1"></i> إضافة دفعة
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-container">
                <!-- Stats will be loaded dynamically -->
            </div>
            
            <!-- Tabs Section -->
            <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
                <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                    <div class="flex space-x-2 space-x-reverse w-full md:w-auto">
                        <button id="tab-payments" class="tab-active px-4 py-2 rounded-lg transition-colors">
                            المعاملات
                        </button>
                        <button id="tab-owners" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            المالكين (<span id="owners-count">0</span>)
                        </button>
                    </div>
                    
                    <div class="flex space-x-2 space-x-reverse w-full md:w-auto justify-center">
                        <select id="month-filter" class="bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">جميع الأشهر</option>
                        </select>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            تصفية الحساب الشهري
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Payments Tab Content -->
            <div id="payments-tab" class="tab-content">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="transactions-container">
                    <!-- Transactions will be loaded dynamically -->
                </div>
            </div>
            
            <!-- Owners Tab Content -->
            <div id="owners-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="owners-container">
                    <!-- Owners will be loaded dynamically -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-8">
            <div class="max-w-7xl mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">عن البرنامج</h3>
                        <p class="text-gray-300">برنامج B Sakan لإدارة العمارات والمصروفات</p>
                        <p class="text-gray-300 mt-2">شركة B Ventures LLC</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">روابط سريعة</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><a href="#" class="hover:text-white transition-colors">الدعم الفني</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الشروط والأحكام</a></li>
                            <li><a href="#" class="hover:text-white transition-colors">الأسئلة الشائعة</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">اتصل بنا</h3>
                        <ul class="space-y-2 text-gray-300">
                            <li><i class="fas fa-envelope mr-2"></i> info@bsakan.com</li>
                            <li><i class="fas fa-phone mr-2"></i> +218-91-123-4567</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">تابعنا</h3>
                        <div class="flex space-x-4 space-x-reverse">
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-4 text-center text-gray-400">
                    <p>© 2025 برنامج B Sakan. جميع الحقوق محفوظة. شركة B Ventures LLC</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Building Modal -->
    <div id="add-building-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة عمارة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل العمارة الجديدة</p>
                
                <form id="add-building-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم العمارة *
                        </label>
                        <input
                            type="text"
                            name="buildingName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل اسم العمارة"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            العنوان
                        </label>
                        <input
                            type="text"
                            name="buildingAddress"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أدخل عنوان العمارة"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            عدد الوحدات
                        </label>
                        <input
                            type="number"
                            name="unitsCount"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="عدد الوحدات السكنية"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors"
                        >
                            إضافة العمارة
                        </button>
                        <button
                            type="button"
                            id="cancel-building-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Owner Modal -->
    <div id="add-owner-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة مالك جديد</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل مالك الشقة الجديد</p>
                
                <form id="add-owner-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اسم المالك *
                        </label>
                        <input
                            type="text"
                            name="name"
                            class="w-full px-3 py-2 border border-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="أدخل اسم المالك"
                            required
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            رقم الهاتف
                        </label>
                        <input
                            type="tel"
                            name="phone"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="0791234567"
                        />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                رقم الشقة
                            </label>
                            <input
                                type="text"
                                name="apartmentNumber"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="1"
                            />
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                الطابق
                            </label>
                            <input
                                type="text"
                                name="floor"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="الأول"
                            />
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            اتجاه الشقة
                        </label>
                        <select
                            name="direction"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">اختر اتجاه الشقة</option>
                            <option value="north">شمال</option>
                            <option value="south">جنوب</option>
                            <option value="east">شرق</option>
                            <option value="west">غرب</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            الاشتراك الشهري (د.أ)
                        </label>
                        <input
                            type="number"
                            name="subscription"
                            value="100.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة المالك
                        </button>
                        <button
                            type="button"
                            id="cancel-owner-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">إضافة دفعة جديدة</h2>
                <p class="text-gray-600 mb-6">أدخل تفاصيل الدفعة الجديدة سواء كانت واردات أو مصروفات</p>
                
                <form id="add-payment-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            نوع الدفعة
                        </label>
                        <select
                            name="type"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="income">واردات</option>
                            <option value="expense">مصروفات</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            المبلغ (د.أ)
                        </label>
                        <input
                            type="number"
                            name="amount"
                            value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            step="0.01"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            وصف الدفعة
                        </label>
                        <input
                            type="text"
                            name="description"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="مثالاً: اشتراك شقة رقم 1 أو أجرة سباك"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            مالك الشقة *
                        </label>
                        <select
                            name="owner"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                            id="payment-owner-select"
                        >
                            <option value="">اختر مالك الشقة</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            تاريخ الدفعة
                        </label>
                        <input
                            type="date"
                            name="date"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            id="payment-date"
                        />
                    </div>
                    
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <input
                            type="checkbox"
                            name="advancePayment"
                            class="h-4 w-4 text-blue-600 rounded"
                            id="advance-payment-checkbox"
                        />
                        <label for="advance-payment-checkbox" class="text-sm font-medium text-gray-700">
                            دفعة مقدمة لعدة شهور
                        </label>
                    </div>
                    
                    <div id="months-selection" class="bg-gray-50 p-4 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">اختر الشهور المدفوعة</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2" id="months-grid">
                            <!-- Months will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            ملاحظات (اختياري)
                        </label>
                        <textarea
                            name="notes"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="أي ملاحظات إضافية..."
                        ></textarea>
                    </div>
                    
                    <div class="flex space-x-3 space-x-reverse pt-4">
                        <button
                            type="submit"
                            class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            إضافة الدفعة
                        </button>
                        <button
                            type="button"
                            id="cancel-payment-btn"
                            class="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg w-full max-w-md receipt-border receipt-print" style="max-width: 500px;">
            <div class="p-6">
                <!-- Header -->
                <div class="text-center mb-6">
                    <div class="flex items-center justify-center mb-2">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg ml-2">
                            B
                        </div>
                        <span class="text-xl font-bold">Sakan</span>
                    </div>
                    <p class="text-gray-600 text-sm">شركة B Ventures LLC</p>
                    <h1 class="text-lg font-bold mt-2">برنامج B Sakan لإدارة وإصلاح ومصروفات العمارات</h1>
                    <p class="text-red-500 font-semibold" id="receipt-building-name">عمارة السالم 12</p>
                </div>
                
                <!-- Receipt Details -->
                <div class="border-t border-b border-gray-300 py-4 mb-4">
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">سند قبض</h2>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium">رقم السند:</span>
                            <span id="receipt-number">50</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">التاريخ:</span>
                            <span id="receipt-date">10-16-2025 م (1447-04-24 هـ)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">وصف الدفعة:</span>
                            <span id="receipt-description">تأمين للعمارة</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">اسم المستفيد:</span>
                            <span id="receipt-resident">محمد أحمد</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">رقم الشقة:</span>
                            <span id="receipt-unit">1</span>
                        </div>
                        <div class="flex justify-between" id="receipt-months-container">
                            <!-- Months will be added here if advance payment -->
                        </div>
                    </div>
                </div>
                
                <!-- Amount Section -->
                <div class="border-2 border-green-500 rounded-lg p-4 mb-6 text-center">
                    <p class="text-gray-600 mb-2">المبلغ المستلم</p>
                    <p class="text-green-600 text-3xl font-bold" id="receipt-amount">50 دينار أردني</p>
                </div>
                
                <!-- Footer -->
                <div class="text-center text-gray-600 text-sm">
                    <p class="font-medium mb-2">ملاحظات:</p>
                    <p class="mb-4" id="receipt-notes">قسط التامين السنوي</p>
                    <div class="flex items-center justify-center">
                        <span>www.bsakan.com</span>
                        <svg class="w-4 h-4 text-green-500 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                    </div>
                </div>
                
                <div class="mt-6 text-center flex space-x-3 space-x-reverse justify-center no-print">
                    <button id="print-receipt-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-print mr-1"></i> طباعة
                    </button>
                    <button id="share-receipt-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fab fa-whatsapp mr-1"></i> مشاركة عبر واتساب
                    </button>
                    <button id="close-receipt-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Data Management
        class DataManager {
            constructor() {
                this.buildings = this.loadFromStorage('buildings') || [
                    { id: 1, name: 'عمارة السالم 12', address: 'شارع السالم', units: 12, notes: '' }
                ];
                this.owners = this.loadFromStorage('owners') || [];
                this.transactions = this.loadFromStorage('transactions') || [];
                this.currentBuildingId = this.loadFromStorage('currentBuildingId') || 1;
            }

            saveToStorage(key, data) {
                localStorage.setItem(`bsakan_${key}`, JSON.stringify(data));
            }

            loadFromStorage(key) {
                const data = localStorage.getItem(`bsakan_${key}`);
                return data ? JSON.parse(data) : null;
            }

            // Buildings
            addBuilding(building) {
                building.id = Date.now();
                this.buildings.push(building);
                this.saveToStorage('buildings', this.buildings);
                return building;
            }

            getCurrentBuilding() {
                return this.buildings.find(b => b.id === this.currentBuildingId) || this.buildings[0];
            }

            setCurrentBuilding(buildingId) {
                this.currentBuildingId = buildingId;
                this.saveToStorage('currentBuildingId', buildingId);
            }

            // Owners
            addOwner(owner) {
                owner.id = Date.now();
                owner.buildingId = this.currentBuildingId;
                this.owners.push(owner);
                this.saveToStorage('owners', this.owners);
                return owner;
            }

            getBuildingOwners() {
                return this.owners.filter(owner => owner.buildingId === this.currentBuildingId);
            }

            deleteOwner(ownerId) {
                this.owners = this.owners.filter(owner => owner.id !== ownerId);
                this.saveToStorage('owners', this.owners);
            }

            // Transactions
            addTransaction(transaction) {
                transaction.id = Date.now();
                transaction.buildingId = this.currentBuildingId;
                transaction.createdAt = new Date().toISOString();
                this.transactions.push(transaction);
                this.saveToStorage('transactions', this.transactions);
                return transaction;
            }

            getBuildingTransactions(monthFilter = '') {
                let transactions = this.transactions.filter(t => t.buildingId === this.currentBuildingId);
                
                if (monthFilter) {
                    transactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        const transactionMonth = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                        return transactionMonth === monthFilter;
                    });
                }
                
                return transactions;
            }

            deleteTransaction(transactionId) {
                this.transactions = this.transactions.filter(t => t.id !== transactionId);
                this.saveToStorage('transactions', this.transactions);
            }

            getBuildingStats(monthFilter = '') {
                const buildingTransactions = this.getBuildingTransactions(monthFilter);
                const income = buildingTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expenses = buildingTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expenses;
                const transactionCount = buildingTransactions.length;

                return {
                    balance: balance.toFixed(2),
                    income: income.toFixed(2),
                    expenses: expenses.toFixed(2),
                    transactionCount
                };
            }

            getAvailableMonths() {
                const months = new Set();
                this.getBuildingTransactions().forEach(transaction => {
                    const date = new Date(transaction.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthName = this.getMonthName(date);
                    months.add(`${monthKey}|${monthName}`);
                });
                return Array.from(months).sort().map(m => {
                    const [key, name] = m.split('|');
                    return { key, name };
                });
            }

            getMonthName(date) {
                const months = [
                    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                return months[date.getMonth()];
            }
        }

        // Initialize Data Manager
        const dataManager = new DataManager();

        // DOM Elements
        const addBuildingBtn = document.getElementById('add-building-btn');
        const addOwnerBtn = document.getElementById('add-owner-btn');
        const addPaymentBtn = document.getElementById('add-payment-btn');
        const addBuildingModal = document.getElementById('add-building-modal');
        const addOwnerModal = document.getElementById('add-owner-modal');
        const addPaymentModal = document.getElementById('add-payment-modal');
        const receiptModal = document.getElementById('receipt-modal');
        const cancelBuildingBtn = document.getElementById('cancel-building-btn');
        const cancelOwnerBtn = document.getElementById('cancel-owner-btn');
        const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
        const closeReceiptBtn = document.getElementById('close-receipt-btn');
        const printReceiptBtn = document.getElementById('print-receipt-btn');
        const shareReceiptBtn = document.getElementById('share-receipt-btn');
        const buildingSelect = document.getElementById('building-select');
        const paymentOwnerSelect = document.getElementById('payment-owner-select');
        const advancePaymentCheckbox = document.getElementById('advance-payment-checkbox');
        const monthsSelection = document.getElementById('months-selection');
        const monthsGrid = document.getElementById('months-grid');
        const statsContainer = document.getElementById('stats-container');
        const transactionsContainer = document.getElementById('transactions-container');
        const ownersContainer = document.getElementById('owners-container');
        const ownersCount = document.getElementById('owners-count');
        const tabPayments = document.getElementById('tab-payments');
        const tabOwners = document.getElementById('tab-owners');
        const paymentsTab = document.getElementById('payments-tab');
        const ownersTab = document.getElementById('owners-tab');
        const monthFilter = document.getElementById('month-filter');

        // Initialize App
        function initApp() {
            loadBuildings();
            loadStats();
            loadTransactions();
            loadOwners();
            loadMonthFilter();
            setupEventListeners();
            setupMonthsGrid();
            setCurrentDate();
        }

        function setupEventListeners() {
            // Modal open/close
            addBuildingBtn.addEventListener('click', () => addBuildingModal.classList.remove('hidden'));
            addOwnerBtn.addEventListener('click', () => addOwnerModal.classList.remove('hidden'));
            addPaymentBtn.addEventListener('click', () => {
                loadOwnerSelect();
                addPaymentModal.classList.remove('hidden');
            });
            
            cancelBuildingBtn.addEventListener('click', () => addBuildingModal.classList.add('hidden'));
            cancelOwnerBtn.addEventListener('click', () => addOwnerModal.classList.add('hidden'));
            cancelPaymentBtn.addEventListener('click', () => addPaymentModal.classList.add('hidden'));
            closeReceiptBtn.addEventListener('click', () => receiptModal.classList.add('hidden'));

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === addBuildingModal) addBuildingModal.classList.add('hidden');
                if (e.target === addOwnerModal) addOwnerModal.classList.add('hidden');
                if (e.target === addPaymentModal) addPaymentModal.classList.add('hidden');
                if (e.target === receiptModal) receiptModal.classList.add('hidden');
            });

            // Form submissions
            document.getElementById('add-building-form').addEventListener('submit', handleAddBuilding);
            document.getElementById('add-owner-form').addEventListener('submit', handleAddOwner);
            document.getElementById('add-payment-form').addEventListener('submit', handleAddPayment);

            // Building selection
            buildingSelect.addEventListener('change', handleBuildingChange);

            // Advance payment checkbox
            advancePaymentCheckbox.addEventListener('change', () => {
                monthsSelection.classList.toggle('hidden', !advancePaymentCheckbox.checked);
            });

            // Print receipt
            printReceiptBtn.addEventListener('click', () => {
                const receiptElement = document.querySelector('.receipt-print');
                const originalDisplay = receiptElement.style.display;
                receiptElement.style.display = 'block';
                window.print();
                receiptElement.style.display = originalDisplay;
            });

            // Share receipt
            shareReceiptBtn.addEventListener('click', shareReceiptViaWhatsApp);

            // Tabs
            tabPayments.addEventListener('click', () => switchTab('payments'));
            tabOwners.addEventListener('click', () => switchTab('owners'));

            // Month filter
            monthFilter.addEventListener('change', handleMonthFilter);
        }

        function switchTab(tab) {
            if (tab === 'payments') {
                tabPayments.classList.add('tab-active');
                tabPayments.classList.remove('bg-gray-100', 'text-gray-600');
                tabOwners.classList.remove('tab-active');
                tabOwners.classList.add('bg-gray-100', 'text-gray-600');
                paymentsTab.classList.remove('hidden');
                ownersTab.classList.add('hidden');
            } else {
                tabOwners.classList.add('tab-active');
                tabOwners.classList.remove('bg-gray-100', 'text-gray-600');
                tabPayments.classList.remove('tab-active');
                tabPayments.classList.add('bg-gray-100', 'text-gray-600');
                ownersTab.classList.remove('hidden');
                paymentsTab.classList.add('hidden');
                loadOwnersList();
            }
        }

        function setupMonthsGrid() {
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            monthsGrid.innerHTML = months.map(month => `
                <button type="button" class="month-btn bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors" data-month="${month}">
                    ${month}
                </button>
            `).join('');

            // Month selection functionality
            monthsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('month-btn')) {
                    const button = e.target;
                    if (button.classList.contains('bg-green-600')) {
                        button.classList.replace('bg-green-600', 'bg-gray-200');
                        button.classList.replace('text-white', 'text-gray-700');
                        button.textContent = button.textContent.replace(' ×', '');
                    } else {
                        button.classList.replace('bg-gray-200', 'bg-green-600');
                        button.classList.replace('text-gray-700', 'text-white');
                        button.textContent += ' ×';
                    }
                }
            });
        }

        function setCurrentDate() {
            const now = new Date();
            document.getElementById('payment-date').value = now.toISOString().split('T')[0];
        }

        function loadMonthFilter() {
            const months = dataManager.getAvailableMonths();
            monthFilter.innerHTML = '<option value="">جميع الأشهر</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.name;
                monthFilter.appendChild(option);
            });
        }

        function handleMonthFilter() {
            loadStats();
            loadTransactions();
        }

        function loadBuildings() {
            buildingSelect.innerHTML = '<option value="">اختر العمارة...</option>';
            dataManager.buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                option.selected = building.id === dataManager.currentBuildingId;
                buildingSelect.appendChild(option);
            });
            updateCurrentBuildingDisplay();
        }

        function loadOwnerSelect() {
            paymentOwnerSelect.innerHTML = '<option value="">اختر مالك الشقة</option>';
            dataManager.getBuildingOwners().forEach(owner => {
                const option = document.createElement('option');
                option.value = owner.id;
                option.textContent = `${owner.name} - شقة ${owner.apartmentNumber}`;
                paymentOwnerSelect.appendChild(option);
            });
        }

        function updateCurrentBuildingDisplay() {
            const currentBuilding = dataManager.getCurrentBuilding();
            document.getElementById('current-building').textContent = currentBuilding.name;
            document.getElementById('receipt-building-name').textContent = currentBuilding.name;
        }

        function handleBuildingChange(e) {
            const buildingId = parseInt(e.target.value);
            if (buildingId) {
                dataManager.setCurrentBuilding(buildingId);
                updateCurrentBuildingDisplay();
                loadStats();
                loadTransactions();
                loadOwners();
                loadMonthFilter();
            }
        }

        function handleAddBuilding(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const building = {
                name: formData.get('buildingName'),
                address: formData.get('buildingAddress'),
                units: parseInt(formData.get('unitsCount')) || 0,
                notes: formData.get('notes')
            };

            const newBuilding = dataManager.addBuilding(building);
            addBuildingModal.classList.add('hidden');
            loadBuildings();
            dataManager.setCurrentBuilding(newBuilding.id);
            
            alert(`تم إضافة العمارة "${building.name}" بنجاح`);
            e.target.reset();
        }

        function handleAddOwner(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const owner = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                apartmentNumber: formData.get('apartmentNumber'),
                floor: formData.get('floor'),
                direction: formData.get('direction'),
                subscription: parseFloat(formData.get('subscription')) || 0,
                notes: formData.get('notes')
            };

            dataManager.addOwner(owner);
            addOwnerModal.classList.add('hidden');
            loadOwners();
            
            alert(`تم إضافة المالك "${owner.name}" بنجاح`);
            e.target.reset();
        }

        function handleAddPayment(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const selectedMonths = Array.from(monthsGrid.querySelectorAll('.month-btn.bg-green-600'))
                .map(btn => btn.textContent.replace(' ×', ''));
            
            const transaction = {
                type: formData.get('type'),
                amount: parseFloat(formData.get('amount')) || 0,
                description: formData.get('description'),
                ownerId: parseInt(formData.get('owner')),
                date: formData.get('date'),
                advancePayment: advancePaymentCheckbox.checked,
                selectedMonths: selectedMonths,
                notes: formData.get('notes')
            };

            const newTransaction = dataManager.addTransaction(transaction);
            addPaymentModal.classList.add('hidden');
            loadStats();
            loadTransactions();
            loadMonthFilter();
            
            // Show receipt
            showReceipt(newTransaction);
            e.target.reset();
            advancePaymentCheckbox.checked = false;
            monthsSelection.classList.add('hidden');
            // Reset month buttons
            monthsGrid.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.replace('bg-green-600', 'bg-gray-200');
                btn.classList.replace('text-white', 'text-gray-700');
                btn.textContent = btn.textContent.replace(' ×', '');
            });
        }

        function loadStats() {
            const selectedMonth = monthFilter.value;
            const stats = dataManager.getBuildingStats(selectedMonth);
            const currentBuilding = dataManager.getCurrentBuilding();
            
            statsContainer.innerHTML = `
                <div class="bg-blue-50 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-600 text-sm">الرصيد الفعلي</p>
                            <p class="text-blue-600 text-2xl font-bold">${stats.balance} د.أ</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">+5%</span>
                    </div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-600 text-sm">الواردات</p>
                            <p class="text-green-600 text-2xl font-bold">${stats.income} د.أ</p>
                        </div>
                        <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-1 rounded-full">0%</span>
                    </div>
                </div>
                <div class="bg-red-50 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-600 text-sm">المصروفات</p>
                            <p class="text-red-600 text-2xl font-bold">${stats.expenses} د.أ</p>
                        </div>
                        <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">-2%</span>
                    </div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-600 text-sm">عدد المعاملات</p>
                            <p class="text-purple-600 text-2xl font-bold">${stats.transactionCount}</p>
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">+15%</span>
                    </div>
                </div>
            `;
        }

        function loadTransactions() {
            const selectedMonth = monthFilter.value;
            const transactions = dataManager.getBuildingTransactions(selectedMonth);
            const owners = dataManager.getBuildingOwners();
            
            if (transactions.length === 0) {
                transactionsContainer.innerHTML = `
                    <div class="bg-white p-8 text-center">
                        <i class="fas fa-receipt text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">لا توجد معاملات مسجلة بعد</p>
                        <button id="add-first-payment" class="bg-green-600 text-white px-4 py-2 rounded-lg mt-4 hover:bg-green-700 transition-colors">
                            إضافة أول دفعة
                        </button>
                    </div>
                `;
                document.getElementById('add-first-payment').addEventListener('click', () => {
                    loadOwnerSelect();
                    addPaymentModal.classList.remove('hidden');
                });
                return;
            }

            const bgColors = ['bg-blue-50', 'bg-green-50', 'bg-pink-50', 'bg-yellow-50'];
            
            transactionsContainer.innerHTML = transactions.map((transaction, index) => {
                const owner = owners.find(o => o.id === transaction.ownerId) || { name: 'غير معروف', apartmentNumber: '--' };
                const bgColor = bgColors[index % bgColors.length];
                const date = new Date(transaction.date).toLocaleDateString('ar-EG');
                const time = new Date(transaction.createdAt).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="${bgColor} p-4 border-b border-gray-200 fade-in relative">
                        <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <input type="checkbox" class="h-4 w-4 text-blue-600 rounded">
                                <div class="flex flex-col">
                                    <span class="font-semibold text-gray-800">${owner.name}</span>
                                    <span class="text-sm text-gray-600">${date} - ${time}</span>
                                    <span class="text-xs text-gray-500">شقة ${owner.apartmentNumber}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 space-x-reverse flex-wrap justify-center gap-2">
                                <span class="bg-${transaction.type === 'income' ? 'green' : 'red'}-100 text-${transaction.type === 'income' ? 'green' : 'red'}-800 px-3 py-1 rounded-full text-xs font-medium">
                                    ${transaction.type === 'income' ? 'واردات' : 'مصروفات'}
                                </span>
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg font-semibold">
                                    ${transaction.amount} د.أ
                                </span>
                                <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm share-btn" data-id="${transaction.id}">
                                    <i class="fab fa-whatsapp mr-1"></i> مشاركة
                                </button>
                                <div class="relative">
                                    <button class="text-gray-500 hover:text-gray-700 dots-btn" data-id="${transaction.id}">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${transaction.description ? `<p class="text-sm text-gray-600 mt-2">${transaction.description}</p>` : ''}
                        ${transaction.advancePayment && transaction.selectedMonths.length > 0 ? `
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-calendar mr-1"></i>
                                الأشهر: ${transaction.selectedMonths.join('، ')}
                            </p>
                        ` : ''}
                    </div>
                `;
            }).join('');

            // Add event listeners to share buttons
            transactionsContainer.querySelectorAll('.share-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const transactionId = parseInt(e.currentTarget.getAttribute('data-id'));
                    shareTransactionViaWhatsApp(transactionId);
                });
            });

            // Add event listeners to dots buttons
            transactionsContainer.querySelectorAll('.dots-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const transactionId = parseInt(e.currentTarget.getAttribute('data-id'));
                    showTransactionMenu(e.currentTarget, transactionId);
                });
            });
        }

        function showTransactionMenu(button, transactionId) {
            // Remove any existing menus
            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.remove());
            
            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            menu.style.top = `${button.offsetTop + button.offsetHeight}px`;
            menu.style.left = `${button.offsetLeft}px`;
            
            menu.innerHTML = `
                <button class="w-full text-right px-4 py-2 hover:bg-gray-100 text-red-600 delete-transaction" data-id="${transactionId}">
                    <i class="fas fa-trash mr-2"></i> حذف
                </button>
            `;
            
            button.parentElement.appendChild(menu);
            
            // Add event listener for delete
            menu.querySelector('.delete-transaction').addEventListener('click', () => {
                dataManager.deleteTransaction(transactionId);
                loadStats();
                loadTransactions();
                menu.remove();
            });
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        function loadOwners() {
            const owners = dataManager.getBuildingOwners();
            ownersCount.textContent = owners.length;
        }

        function loadOwnersList() {
            const owners = dataManager.getBuildingOwners();
            
            if (owners.length === 0) {
                ownersContainer.innerHTML = `
                    <div class="bg-white p-8 text-center">
                        <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">لا توجد مالكين مسجلين بعد</p>
                        <button id="add-first-owner" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-4 hover:bg-blue-700 transition-colors">
                            إضافة أول مالك
                        </button>
                    </div>
                `;
                document.getElementById('add-first-owner').addEventListener('click', () => {
                    addOwnerModal.classList.remove('hidden');
                });
                return;
            }

            const bgColors = ['bg-blue-50', 'bg-green-50', 'bg-pink-50', 'bg-yellow-50'];
            
            ownersContainer.innerHTML = owners.map((owner, index) => {
                const bgColor = bgColors[index % bgColors.length];
                return `
                    <div class="${bgColor} p-4 border-b border-gray-200 fade-in relative">
                        <div class="flex justify-between items-center flex-col md:flex-row gap-4">
                            <div class="flex items-center space-x-4 space-x-reverse">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${owner.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                </div>
                                <div class="flex flex-col">
                                    <span class="font-semibold text-gray-800">${owner.name}</span>
                                    <span class="text-sm text-gray-600">شقة ${owner.apartmentNumber} - الطابق ${owner.floor || 'غير محدد'}</span>
                                    <span class="text-xs text-gray-500">${owner.phone || 'لا يوجد رقم هاتف'}</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4 space-x-reverse flex-wrap justify-center gap-2">
                                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-lg font-semibold">
                                    ${owner.subscription} د.أ
                                </span>
                                <div class="relative">
                                    <button class="text-gray-500 hover:text-gray-700 owner-dots-btn" data-id="${owner.id}">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${owner.notes ? `<p class="text-sm text-gray-600 mt-2">${owner.notes}</p>` : ''}
                    </div>
                `;
            }).join('');

            // Add event listeners to dots buttons
            ownersContainer.querySelectorAll('.owner-dots-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const ownerId = parseInt(e.currentTarget.getAttribute('data-id'));
                    showOwnerMenu(e.currentTarget, ownerId);
                });
            });
        }

        function showOwnerMenu(button, ownerId) {
            // Remove any existing menus
            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.remove());
            
            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            menu.style.top = `${button.offsetTop + button.offsetHeight}px`;
            menu.style.left = `${button.offsetLeft}px`;
            
            menu.innerHTML = `
                <button class="w-full text-right px-4 py-2 hover:bg-gray-100 text-red-600 delete-owner" data-id="${ownerId}">
                    <i class="fas fa-trash mr-2"></i> حذف
                </button>
            `;
            
            button.parentElement.appendChild(menu);
            
            // Add event listener for delete
            menu.querySelector('.delete-owner').addEventListener('click', () => {
                dataManager.deleteOwner(ownerId);
                loadOwners();
                loadOwnersList();
                menu.remove();
            });
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        function showReceipt(transaction) {
            const owner = dataManager.getBuildingOwners().find(o => o.id === transaction.ownerId) || { name: 'غير معروف', apartmentNumber: '--' };
            const currentBuilding = dataManager.getCurrentBuilding();
            
            document.getElementById('receipt-number').textContent = transaction.id;
            document.getElementById('receipt-date').textContent = new Date(transaction.date).toLocaleDateString('ar-EG') + ' م';
            document.getElementById('receipt-description').textContent = transaction.description || 'لا يوجد وصف';
            document.getElementById('receipt-resident').textContent = owner.name;
            document.getElementById('receipt-unit').textContent = owner.apartmentNumber;
            document.getElementById('receipt-amount').textContent = `${transaction.amount} دينار أردني`;
            document.getElementById('receipt-notes').textContent = transaction.notes || 'لا توجد ملاحظات';
            document.getElementById('receipt-building-name').textContent = currentBuilding.name;

            // Handle advance payment months
            const monthsContainer = document.getElementById('receipt-months-container');
            if (transaction.advancePayment && transaction.selectedMonths.length > 0) {
                monthsContainer.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium">الأشهر المدفوعة:</span>
                        <span>${transaction.selectedMonths.join('، ')}</span>
                    </div>
                `;
            } else {
                monthsContainer.innerHTML = '';
            }

            receiptModal.classList.remove('hidden');
        }

        function shareReceiptViaWhatsApp() {
            const residentName = document.getElementById('receipt-resident').textContent;
            const unitNumber = document.getElementById('receipt-unit').textContent;
            const buildingName = document.getElementById('receipt-building-name').textContent;
            const paymentDate = document.getElementById('receipt-date').textContent;
            const paymentAmount = document.getElementById('receipt-amount').textContent;
            const paymentDescription = document.getElementById('receipt-description').textContent;
            const paymentNotes = document.getElementById('receipt-notes').textContent;
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            // Check for advance payment months
            const monthsContainer = document.getElementById('receipt-months-container');
            const monthsText = monthsContainer.innerHTML ? `\n📅 الأشهر المدفوعة: ${monthsContainer.textContent.split(':')[1]?.trim()}` : '';
            
            const message = `🏢 *برنامج B Sakan لإدارة مصروفات العمارات*
شركة B Ventures LLC
📋 *تفاصيل الدفعة*
━━━━━━━━━━━━━━━━
👤 اسم المستفيد: ${residentName}
🏠 رقم الوحدة: ${unitNumber}
🏬 العمارة: ${buildingName}
📅 تاريخ الدفع: ${paymentDate}
💵 المبلغ: ${paymentAmount}
🗒️ وصف الدفعة: ${paymentDescription}${monthsText}
📌 ملاحظات: ${paymentNotes}
✅ تم استلام المبلغ بنجاح ${currentDate}
🤝🏻 شكراً لك لالتزامك`;
            
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        function shareTransactionViaWhatsApp(transactionId) {
            const transaction = dataManager.transactions.find(t => t.id === transactionId);
            const owner = dataManager.getBuildingOwners().find(o => o.id === transaction.ownerId) || { name: 'غير معروف', apartmentNumber: '--' };
            const currentBuilding = dataManager.getCurrentBuilding();
            const currentDate = new Date().toLocaleDateString('ar-EG');
            
            const monthsText = transaction.advancePayment && transaction.selectedMonths.length > 0 ? 
                `\n📅 الأشهر المدفوعة: ${transaction.selectedMonths.join('، ')}` : '';
            
            const message = `🏢 *برنامج B Sakan لإدارة مصروفات العمارات*
شركة B Ventures LLC
📋 *تفاصيل الدفعة*
━━━━━━━━━━━━━━━━
👤 اسم المستفيد: ${owner.name}
🏠 رقم الوحدة: ${owner.apartmentNumber}
🏬 العمارة: ${currentBuilding.name}
📅 تاريخ الدفع: ${new Date(transaction.date).toLocaleDateString('ar-EG')}
💵 المبلغ: ${transaction.amount} د.أ
🗒️ وصف الدفعة: ${transaction.description || 'لا يوجد وصف'}${monthsText}
📌 ملاحظات: ${transaction.notes || 'لا توجد ملاحظات'}
✅ تم استلام المبلغ بنجاح ${currentDate}
🤝🏻 شكراً لك لالتزامك`;
                
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/bsakan-app/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
    </html>
